<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Road Trip Pro - Final</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Rubik', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            background-color: #f8fafc;
        }
        
        html { scroll-behavior: smooth; }

        /* ×× ×™××¦×™×™×ª ×¨×›×‘ */
        @keyframes carEngine {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-1px) scale(1.02); }
        }
        
        .car-marker {
            position: absolute;
            right: 12px; 
            z-index: 30;
            transition: top 1s linear, opacity 0.3s ease; 
            pointer-events: none;
            opacity: 0; 
        }
        
        .car-inner {
            background-color: #2563eb; 
            padding: 6px;
            border-radius: 9999px;
            border: 3px solid white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            animation: carEngine 2s infinite ease-in-out;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .btn-press { transition: transform 0.1s; }
        .btn-press:active { transform: scale(0.96); }
    </style>
</head>
<body class="text-slate-800 pb-32">

    <!-- Header -->
    <div class="fixed top-0 left-0 right-0 bg-white/95 backdrop-blur-md border-b border-gray-200 px-5 py-4 z-40 shadow-sm transition-all">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-black tracking-tight text-blue-700 flex items-center gap-2">
                    <i data-lucide="map" class="text-blue-500 w-5 h-5"></i>
                    ××¡×¢ ×›×‘×™×© 1
                </h1>
                <div class="flex items-center gap-2">
                    <p class="text-xs text-gray-500 font-medium">×œ×•×¡ ×× ×’'×œ×¡ â¬…ï¸ ×¡×Ÿ ×¤×¨× ×¡×™×¡×§×•</p>
                    <span id="liveIndicator" class="hidden flex h-2 w-2 relative">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                </div>
            </div>
            
            <button id="actionBtn" onclick="handleMainButton()" class="btn-press bg-green-600 text-white px-5 py-2.5 rounded-full text-xs font-bold flex items-center gap-2 shadow-lg shadow-green-200 border border-transparent transition-all">
                <i id="btnIcon" data-lucide="navigation" class="w-4 h-4"></i>
                <span id="btnText">×”×¤×¢×œ ×–××Ÿ ×××ª</span>
            </button>
        </div>
        
        <div id="statusMsg" class="hidden text-center mt-2 text-[11px] font-bold text-orange-500 bg-orange-50 py-1 rounded-lg border border-orange-100 max-w-md mx-auto">
            ×××ª×™×Ÿ ×œ×§×œ×™×˜×ª GPS...
        </div>
    </div>

    <!-- Main Container -->
    <div class="max-w-md mx-auto px-5 pt-24 relative min-h-screen">
        
        <!-- Timeline Line -->
        <div class="absolute top-0 bottom-0 right-[29px] w-[3px] bg-gradient-to-b from-blue-500 via-slate-300 to-slate-200 z-0 rounded-full opacity-50"></div>

        <!-- Itinerary Items -->
        <div id="itinerary-container"></div>

    </div>

    <!-- Main Modal (Details) -->
    <div id="mainModal" class="fixed inset-0 z-50 hidden flex items-end justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="bg-white w-full max-w-md rounded-t-3xl shadow-2xl animate-[slideIn_0.3s_ease-out] relative z-10 max-h-[92vh] flex flex-col overflow-hidden">
            <div id="modalContent" class="flex flex-col h-full overflow-y-auto no-scrollbar pb-6"></div>
        </div>
    </div>

    <!-- Gas Modal -->
    <div id="gasModal" class="fixed inset-0 z-50 hidden flex items-end justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeGasModal()"></div>
        <div class="bg-white w-full max-w-md rounded-t-3xl shadow-2xl relative z-10 max-h-[85vh] flex flex-col">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-orange-50 rounded-t-3xl sticky top-0 z-20">
                <div>
                    <h2 class="text-xl font-black text-orange-600 flex items-center gap-2">
                        <i data-lucide="fuel" class="w-6 h-6"></i> ×“×œ×§ ×–×•×œ ×‘×“×¨×š
                    </h2>
                    <p class="text-xs text-orange-400 font-bold mt-1">×”×ª×—× ×•×ª ×”××©×ª×œ××•×ª ×‘××§×˜×¢ ×–×”</p>
                </div>
                <button onclick="closeGasModal()" class="bg-white text-orange-400 p-2 rounded-full shadow-sm btn-press"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="gasModalContent" class="p-5 space-y-4 overflow-y-auto bg-slate-50 no-scrollbar"></div>
        </div>
    </div>

    <script>
        // --- DATA ---
        
        const GAS_STATIONS = {
            'start': [ { name: "ARCO Oxnard", address: "1935 N Oxnard Blvd", price: "$4.39", note: "×–×•×œ! ××–×•××Ÿ/Debit" }, { name: "United Oil", address: "2888 E Thousand Oaks Blvd", price: "$4.45", note: "×¢×œ ×”×“×¨×š" }, { name: "Valero", address: "500 S Ventura Rd", price: "$4.49", note: "××—×™×¨ ×”×•×’×Ÿ" } ],
            'sb': [ { name: "Fuel Depot", address: "5767 Calle Real", price: "$4.55", note: "×‘×™×¦×™××” ××¡× ×˜×” ×‘×¨×‘×¨×”" }, { name: "ARCO Buellton", address: "175 E Hwy 246", price: "$4.35", note: "×‘×›× ×™×¡×” ×œ×¡×•×œ×‘× ×’" } ],
            'solvang': [ { name: "ARCO Pismo", address: "898 Oak Park Blvd", price: "$4.29", note: "××•××œ×¥ ×××•×“!" }, { name: "Speedway", address: "1350 Grand Ave", price: "$4.35", note: "" } ],
            'gas': [ { name: "Morro Bay Fuel", address: "1590 Main St", price: "$4.45", note: "×‘×ª×•×š ×”×¢×™×¨" }, { name: "Sinclair", address: "940 Morro Bay Blvd", price: "$4.49", note: "×“×™× ×•×–××•×¨ ×™×¨×•×§" } ],
            'morro': [ { name: "Chevron Cambria", address: "2194 Main St", price: "$5.89", note: "×™×§×¨ ×××•×“" }, { name: "××–×”×¨×”", address: "××™×Ÿ ×“×œ×§ ×–×•×œ ××›××Ÿ!", price: "---", note: "×ª×“×œ×§×• ×‘××•×¨×• ×‘×™×™" } ],
            'seals': [ { name: "Ragged Point", address: "19019 CA-1", price: "$7.99", note: "×—×™×¨×•× ×‘×œ×‘×“" }, { name: "Gorda Gas", address: "Big Sur", price: "$7.50", note: "×—×™×¨×•× ×‘×œ×‘×“" } ],
            'monterey': [ { name: "Safeway Fuel", address: "104 Canyon Del Rey", price: "$4.25", note: "×”×›×™ ×–×•×œ ×‘××–×•×¨" }, { name: "Valero", address: "2200 N Fremont St", price: "$4.39", note: "××—×™×¨ ×˜×•×‘" } ],
            'mcway': [ { name: "××–×”×¨×”", address: "××™×Ÿ ×“×œ×§ ×‘×‘×™×’ ×¡×¨", price: "---", note: "××œ××• ×‘××•× ×˜×¨×™×™ ×œ×¤× ×™ ×”×™×¦×™××”!" } ],
            'bixby': [ { name: "Shell Carmel", address: "3745 Via Nona Marie", price: "$4.79", note: "×‘×›× ×™×¡×” ×œ×›×¨××œ" } ],
            'carmel': [ { name: "Costco Gas", address: "Half Moon Bay", price: "$4.15", note: "×—×‘×¨×™× ×‘×œ×‘×“" }, { name: "Chevron Pacifica", address: "500 Linda Mar Blvd", price: "$4.65", note: "×œ×¤× ×™ SF" } ]
        };

        const ITINERARY = [
            // --- DAY 1 ---
            {
                id: 'start',
                title: '×™×¦×™××”: ×œ×•×¡ ×× ×’\'×œ×¡',
                originalTime: '09:00',
                displayTime: '09:00',
                subTitle: '××ª×—×™×œ×™× ××ª ×”××¡×¢',
                type: 'start',
                icon: 'car',
                coords: { lat: 34.0528, lng: -118.2556 },
                parking: { name: '×œ×•×‘×™ ×”××œ×•×Ÿ', coords: { lat: 34.0528, lng: -118.2556 }, cost: '---' },
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ3p6yTIcIs92AnFZfplUcSVPCaXzjjpc_hdRUxa4vbcA&s=10",
                longDesc: `
                    <p class="mb-2">×™×•×¦××™× ×œ×“×¨×š! ×•×•×“××• ×©××¨×–×ª× ×”×›×œ ×•×©×”×¨×›×‘ ××•×›×Ÿ.</p>
                    <ul class="list-disc list-inside space-y-1 text-sm text-gray-600 mb-3">
                        <li>×™×¦×™××” ×“×¨×š ×›×‘×™×© 101 ××¢×¨×‘×”.</li>
                        <li>×‘×“×§×• ×©×™×© ×œ×›× ××™× ×•×›×‘×œ ×˜×¢×™× ×”.</li>
                    </ul>`,
                walkingRoute: null
            },
            {
                id: 'sb',
                title: '×¡× ×˜×” ×‘×¨×‘×¨×”',
                subTitle: 'Stearns Wharf',
                originalTime: '11:00',
                displayTime: '11:00',
                type: 'stop',
                icon: 'anchor',
                coords: { lat: 34.4123, lng: -119.6876 }, 
                parking: { name: 'City Lot #1', address: '23 E Cabrillo Blvd', coords: { lat: 34.4137, lng: -119.6905 }, cost: '×—×™× × 75 ×“×§×³ ×¨××©×•× ×•×ª' },
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSB1m_VYizll6MT567ggSruv9ImG91t4HKdwqXT1wxLWA&s=10",
                longDesc: `
                    <p class="mb-2"><strong>×”×¨×™×‘×™×™×¨×” ×”×××¨×™×§××™×ª.</strong> ×¢×™×¨ ×—×•×£ ×™×¤×”×¤×™×™×” ×¢× ××¨×›×™×˜×§×˜×•×¨×” ×¡×¤×¨×“×™×ª.</p>
                    <div class="bg-blue-50 p-3 rounded-lg mb-3 border border-blue-100">
                        <h4 class="font-bold text-blue-700 text-xs mb-1">××” ×¢×•×©×™× ×›××Ÿ?</h4>
                        <ul class="list-disc list-inside space-y-1 text-xs text-gray-700">
                            <li>×”×œ×™×›×” ×¢×œ ×”××–×— ×”×”×™×¡×˜×•×¨×™ (Stearns Wharf).</li>
                            <li>×‘×™×§×•×¨ ×‘×‘×™×ª ×”××©×¤×˜ (×ª×¦×¤×™×ª ×—×™× ×).</li>
                            <li>×¡×™×‘×•×‘ ×§×¦×¨ ×‘×¨×—×•×‘ ×”××“×™× ×” (State Street).</li>
                        </ul>
                    </div>`,
                walkingRoute: "https://www.google.com/maps/dir/Stearns+Wharf,+217+Stearns+Wharf,+Santa+Barbara,+CA+93101/State+St,+Santa+Barbara,+CA/@34.416668,-119.6967757,16z"
            },
            {
                id: 'solvang',
                title: '×¡×•×œ×‘× ×’',
                subTitle: '×”×¢×™×™×¨×” ×”×“× ×™×ª',
                originalTime: '12:30',
                displayTime: '12:30',
                type: 'stop',
                icon: 'coffee',
                coords: { lat: 34.5958, lng: -120.1376 },
                parking: { name: 'Public Parking', address: '1616 Oak St', coords: { lat: 34.5945, lng: -120.1408 }, cost: '×—×™× ×' },
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS2NgP8pvIZShu5F_1XhFvbqpMI-fDt3sSXwxNpXw4IHg&s=10",
                longDesc: `
                    <p class="mb-2"><strong>×“× ××¨×§ ×”×§×˜× ×”.</strong> ×”×›×œ × ×¨××” ×›××• ×‘××’×“×•×ª - ×˜×—× ×•×ª ×¨×•×— ×•×××¤×™×•×ª.</p>
                    <div class="bg-orange-50 p-3 rounded-lg mb-3 border border-orange-100">
                        <h4 class="font-bold text-orange-700 text-xs mb-1">×”××œ×¦×•×ª ×œ×‘×™×§×•×¨:</h4>
                        <ul class="list-disc list-inside space-y-1 text-xs text-gray-700">
                            <li>×—×•×‘×” ×œ×˜×¢×•× Aebleskiver (×¡×•×¤×’× ×™×•×ª ×“× ×™×•×ª).</li>
                            <li>×¦×™×œ×•× ×œ×™×“ ×˜×—× ×•×ª ×”×¨×•×—.</li>
                        </ul>
                    </div>`,
                walkingRoute: "https://www.google.com/maps/dir/Solvang+Visitor+Center/The+Little+Mermaid+Fountain"
            },
            {
                id: 'gas',
                title: '×ª×“×œ×•×§ ×—×•×‘×”!',
                subTitle: '×¡×Ÿ ×œ×•××™×¡ ××•×‘×™×¡×¤×•',
                originalTime: '14:30',
                displayTime: '14:30',
                type: 'gas',
                icon: 'fuel',
                coords: { lat: 35.2675, lng: -120.6481 },
                parking: { name: 'Conserv Fuel', address: '2211 Broad St', coords: { lat: 35.2675, lng: -120.6481 }, cost: '××—×™×¨ ×”×•×’×Ÿ' },
                isEmoji: true, emoji: "â›½", bgGradient: "from-orange-400 to-red-500",
                longDesc: `
                    <p class="mb-2 font-bold text-red-600">×¢×¦×™×¨×” ×§×¨×™×˜×™×ª!</p>
                    <p class="text-sm text-gray-700">×–×” ×”××§×•× ×”××—×¨×•×Ÿ ×œ×ª×“×œ×§ ×‘××—×™×¨ ×©×¤×•×™ ×œ×¤× ×™ Big Sur.</p>`,
                walkingRoute: null
            },
            {
                id: 'morro',
                title: '××•×¨×• ×‘×™×™',
                subTitle: 'Morro Rock',
                originalTime: '15:00',
                displayTime: '15:00',
                type: 'stop',
                icon: 'camera',
                coords: { lat: 35.3712, lng: -120.8667 },
                parking: { name: 'Coleman Park', address: 'Coleman Dr', coords: { lat: 35.3705, lng: -120.8650 }, cost: '×—×™× ×' },
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQNR-4naNKMPmIiq99YbgSSK0VvTVhUrTG-W_7YMbSYOg&s=10",
                longDesc: `
                    <p class="mb-2">×¡×œ×¢ ×’×¢×©×™ ×¢×¦×•× ×©×‘×•×§×¢ ××”×™×.</p>
                    <ul class="list-disc list-inside space-y-1 text-sm text-gray-600 mb-3">
                        <li>×—×¤×©×• ×œ×•×˜×¨×•×ª ×™× ×‘××¤×¨×¥.</li>
                        <li>××¡×•×¨ ×œ×˜×¤×¡ ×¢×œ ×”×¡×œ×¢.</li>
                    </ul>`,
                walkingRoute: "https://www.google.com/maps/dir/Coleman+Park,+Morro+Bay,+CA/Morro+Rock"
            },
            {
                id: 'seals',
                title: '×¤×™×œ×™ ×”×™×',
                subTitle: 'San Simeon',
                originalTime: '16:15',
                displayTime: '16:15',
                type: 'stop',
                icon: 'fish',
                coords: { lat: 35.6630, lng: -121.2575 },
                parking: { name: 'Vista Point', address: 'Hwy 1', coords: { lat: 35.6630, lng: -121.2575 }, cost: '×—×™× ×' },
                isEmoji: true, emoji: "ğŸ¦­", bgGradient: "from-blue-400 to-cyan-600",
                longDesc: `
                    <p class="mb-2"><strong>×ª×•×¤×¢×ª ×˜×‘×¢.</strong> ××œ×¤×™ ×¤×™×œ×™ ×™× ×©×•×›×‘×™× ×¢×œ ×”×—×•×£.</p>
                    <p class="text-sm">×™×© ××¡×œ×•×œ ×”×œ×™×›×” ××¢×¥ ×œ×ª×¦×¤×™×ª ×‘×˜×•×—×”.</p>`,
                walkingRoute: "https://www.google.com/maps/dir/Elephant+Seal+Vista+Point/Elephant+Seal+Viewing+Walkway"
            },
            {
                id: 'monterey',
                title: '×œ×™× ×” ×‘××•× ×˜×¨×™×™',
                subTitle: 'Victorian Inn',
                originalTime: '18:30',
                displayTime: '18:30',
                type: 'hotel',
                icon: 'bed',
                coords: { lat: 36.6128, lng: -121.9001 },
                parking: { name: '×—× ×™×•×Ÿ ×”××œ×•×Ÿ', address: '487 Foam St', coords: { lat: 36.6128, lng: -121.9001 }, cost: '×œ××•×¨×—×™×' },
                isEmoji: true, emoji: "ğŸ¨", bgGradient: "from-indigo-500 to-purple-600",
                longDesc: `
                    <p class="mb-2">×”×’×¢×ª×! ××œ×•×Ÿ ×‘×¡×’× ×•×Ÿ ×•×™×§×˜×•×¨×™×× ×™ ×œ×™×“ Cannery Row.</p>
                    <ul class="list-disc list-inside space-y-1 text-sm text-gray-600">
                        <li>×™×¦×™××” ×œ×¡×™×‘×•×‘ ×¢×¨×‘ ×‘-Cannery Row.</li>
                        <li>××¨×•×—×ª ×‘×•×§×¨ ×›×œ×•×œ×”.</li>
                    </ul>`,
                walkingRoute: "https://www.google.com/maps/dir/Victorian+Inn/Cannery+Row"
            },
            
            { id: 'day2', title: '×™×•× ×©× ×™ - ×”×ª×™×§×•×Ÿ ×”×’×“×•×œ', type: 'divider' },
            
            {
                id: 'mcway',
                title: '××¤×œ×™ ××§×•×•××™',
                subTitle: 'Julia Pfeiffer Burns',
                originalTime: '09:45',
                displayTime: '09:45',
                type: 'stop',
                icon: 'camera',
                coords: { lat: 36.1580, lng: -121.6695 },
                parking: { name: '×—× ×™×•×Ÿ ×”×©××•×¨×”', address: 'McWay Falls Trailhead', coords: { lat: 36.1585, lng: -121.6698 }, cost: '$10 ××• ×—×™× × ×‘×›×‘×™×©' },
                image: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/McWay_Falls_2023.jpg/800px-McWay_Falls_2023.jpg",
                longDesc: `
                    <p class="mb-2"><strong>××—×“ ×”××§×•××•×ª ×”×™×¤×™× ×‘×¢×•×œ×.</strong> ××¤×œ ×©× ×•×¤×œ ××’×•×‘×” 25 ××˜×¨ ×™×©×™×¨×•×ª ×œ×—×•×£ ×˜×•×¨×§×™×– ×‘×ª×•×œ×™.</p>
                    <div class="bg-teal-50 p-3 rounded-lg mb-3 border border-teal-100">
                        <h4 class="font-bold text-teal-700 text-xs mb-1">×”×•×¨××•×ª ×”×’×¢×”:</h4>
                        <ul class="list-disc list-inside space-y-1 text-xs text-gray-700">
                            <li>× ×•×¡×¢×™× ×××•× ×˜×¨×™×™ ×›-×©×¢×” ×“×¨×•××”.</li>
                            <li>×—×•× ×™× ×‘×©××•×¨×” (×‘×ª×©×œ×•×) ××• ×‘×–×”×™×¨×•×ª ×‘×¦×“ ×”×›×‘×™×©.</li>
                            <li>×”×•×œ×›×™× ×‘×× ×”×¨×” ××ª×—×ª ×œ×›×‘×™×© ×œ×ª×¦×¤×™×ª (10 ×“×§×•×ª ×”×œ×™×›×”).</li>
                            <li><strong>×©×™××• ×œ×‘:</strong> ××™ ××¤×©×¨ ×œ×¨×“×ª ×œ×—×•×£ ×¢×¦××•! ×¨×§ ×ª×¦×¤×™×ª.</li>
                        </ul>
                    </div>`,
                walkingRoute: "https://www.google.com/maps/dir/McWay+Falls+Parking/McWay+Falls+Viewpoint"
            },
            {
                id: 'bixby',
                title: '×’×©×¨ ×‘×™×§×¡×‘×™',
                subTitle: '×‘×—×–×¨×” ×¦×¤×•× ×”',
                originalTime: '11:30',
                displayTime: '11:30',
                type: 'stop',
                icon: 'camera',
                coords: { lat: 36.3714, lng: -121.9017 },
                parking: { name: '××¤×¨×¥ ×¦×¤×•× ×™', address: 'Hwy 1', coords: { lat: 36.3725, lng: -121.9030 }, cost: '×—×™× ×' },
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ2zJIDl1fe1ZGo7UfUrx2iHn1dYXzNNPtTfggtnUme6A&s=10",
                longDesc: `
                    <p class="mb-2"><strong>×”××™×™×§×•×Ÿ ×©×œ ×›×‘×™×© 1.</strong> ×¢×•×¦×¨×™× ×›××Ÿ ×‘×“×¨×š ×—×–×¨×” ××”××¤×œ ×¦×¤×•× ×”.</p>
                    <ul class="list-disc list-inside space-y-1 text-sm text-gray-600 mb-3">
                        <li>×”×—× ×™×” ×”×™× ×‘××¤×¨×¥ ×¢×¤×¨ ×‘×¦×“ ×”×¦×¤×•× ×™ ×©×œ ×”×’×©×¨ (×œ×›×™×•×•×Ÿ ××•× ×˜×¨×™×™).</li>
                        <li>×–×”×™×¨×•×ª ×‘×—×¦×™×™×ª ×”×›×‘×™×©!</li>
                    </ul>`,
                walkingRoute: null
            },
            {
                id: 'carmel',
                title: '×›×¨××œ',
                subTitle: '××¨×•×—×ª ×¦×”×¨×™×™×',
                originalTime: '12:15',
                displayTime: '12:15',
                type: 'stop',
                icon: 'coffee',
                coords: { lat: 36.5552, lng: -121.9233 },
                parking: { name: 'Vista Lobos', address: '3rd Ave & Torres St', coords: { lat: 36.5560, lng: -121.9215 }, cost: '×—×™× ×' },
                image: "https://dynamic-media-cdn.tripadvisor.com/media/photo-o/0a/66/e2/75/20160221-091502-1-largejpg.jpg?w=600&h=-1&s=1",
                longDesc: `
                    <p class="mb-2"><strong>×¢×™×™×¨×ª ×”××’×“×•×ª.</strong> ×–××Ÿ ××¦×•×™×Ÿ ×œ××¨×•×—×ª ×¦×”×¨×™×™× ×•×¡×™×‘×•×‘ ×‘×—×•×£ ×”×œ×‘×Ÿ.</p>
                    <div class="bg-gray-50 p-3 rounded-lg mb-3 border border-gray-200">
                        <h4 class="font-bold text-gray-700 text-xs mb-1">×˜×™×¤:</h4>
                        <ul class="list-disc list-inside space-y-1 text-xs text-gray-600">
                            <li>×—× ×• ××ª ×”×¨×›×‘ ×‘×—×™× × ×‘×—× ×™×•×Ÿ Vista Lobos.</li>
                            <li>×¨×“×• ×‘×¨×’×œ ××ª Ocean Avenue ×¢×“ ×œ×™×.</li>
                        </ul>
                    </div>`,
                walkingRoute: "https://www.google.com/maps/dir/Ocean+Ave,+Carmel/Carmel+Beach"
            },
            {
                id: 'sf',
                title: '×¡×™×•×: ×¡×Ÿ ×¤×¨× ×¡×™×¡×§×•',
                subTitle: 'Fisherman\'s Wharf',
                originalTime: '17:00',
                displayTime: '17:00',
                type: 'stop',
                icon: 'anchor',
                coords: { lat: 37.8080, lng: -122.4177 },
                parking: { name: '×—× ×™×•×Ÿ ×”××œ×•×Ÿ', coords: { lat: 37.8080, lng: -122.4177 }, cost: '$50-$70 ×œ×œ×™×œ×”' },
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcThRZsv_ufgRrqGw4E1tFyxdTSwAQoAxAfQGk5jrZAlaTvcZzTjQ3fM_-J5&s=10",
                longDesc: `
                    <p class="mb-2"><strong>×”×’×¢×ª× ×œ×™×¢×“ ×”×¡×•×¤×™!</strong></p>
                    <ul class="list-disc list-inside space-y-1 text-sm text-gray-600 mb-3">
                        <li>×œ×¨××•×ª ××ª ××¨×™×•×ª ×”×™× ×‘-Pier 39.</li>
                        <li>×œ××›×•×œ ××¨×§ ×¦×“×¤×•×ª (Clam Chowder).</li>
                        <li>×”×—×–×¨×ª ×”×¨×›×‘ ×•×¦'×§-××™×Ÿ ×‘××œ×•×Ÿ.</li>
                    </ul>`,
                walkingRoute: "https://www.google.com/maps/dir/Fisherman's+Wharf,+San+Francisco,+CA/Pier+39"
            }
        ];

        // --- UTILS ---
        
        function deg2rad(deg) { return deg * (Math.PI/180); }
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function getDriveTime(distKm) {
            // Factor 1.3 for traffic/winding roads, Speed 75 km/h avg
            const minutes = Math.round((distKm * 1.3 / 75) * 60);
            const hrs = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (hrs > 0) return `${hrs} ×©×³ ${mins} ×“×§×³`;
            return `${mins} ×“×§×³ × ×¡×™×¢×”`;
        }

        // --- STATE ---
        let isTracking = false;
        let userLocation = null;

        // --- CORE LOGIC ---

        function initItinerary() {
            const container = document.getElementById('itinerary-container');
            container.innerHTML = '';

            ITINERARY.forEach((stop, index) => {
                
                // --- RENDER DIVIDER ---
                if (stop.type === 'divider') {
                    container.innerHTML += `
                        <div class="relative z-10 my-10 flex items-center justify-center">
                            <span class="bg-slate-800 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-md tracking-wide border-2 border-slate-600">
                                ${stop.title}
                            </span>
                        </div>`;
                    return;
                }

                // --- CALCULATE DRIVE TIME FROM PREV STOP ---
                let driveTimeHtml = '';
                if (index > 0) {
                    const prevStop = ITINERARY[index - 1];
                    if (prevStop.type !== 'divider') {
                        const dist = getDistance(prevStop.coords.lat, prevStop.coords.lng, stop.coords.lat, stop.coords.lng);
                        const timeStr = getDriveTime(dist);
                        driveTimeHtml = `
                            <div class="absolute -top-6 right-[46px] z-0 flex items-center gap-1">
                                <div class="h-8 w-0 border-r-2 border-dotted border-slate-300"></div>
                                <span class="text-[10px] text-slate-400 bg-slate-100 px-1.5 rounded whitespace-nowrap">${timeStr}</span>
                            </div>
                        `;
                    }
                }

                const showGas = index < ITINERARY.length - 1 && ITINERARY[index+1].type !== 'divider' && GAS_STATIONS[stop.id];

                let mediaHtml = stop.isEmoji 
                    ? `<div class="w-full h-full bg-gradient-to-br ${stop.bgGradient} flex items-center justify-center text-6xl drop-shadow-md select-none">${stop.emoji}</div>`
                    : `<img src="${stop.image}" class="w-full h-full object-cover select-none">`;

                // --- RENDER ITEM ---
                container.innerHTML += `
                    <div id="stop-item-${index}" class="relative mb-8">
                        ${driveTimeHtml}

                        <div id="car-${index}" class="car-marker" style="top: 0%;">
                            <div class="car-inner"><i data-lucide="car" class="w-4 h-4 text-white"></i></div>
                        </div>

                        <div class="flex items-start gap-4">
                            <div id="dot-${index}" class="relative shrink-0 w-8 h-8 rounded-full border-[3px] z-10 flex items-center justify-center bg-white shadow-sm mt-8 transition-colors duration-500 border-slate-300">
                                <div id="inner-dot-${index}" class="w-2.5 h-2.5 rounded-full transition-colors duration-500 bg-slate-300"></div>
                            </div>

                            <div id="card-${index}" onclick="openModal(${index})" class="relative grow bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden cursor-pointer btn-press transition-all duration-300">
                                <div class="h-32 w-full relative bg-gray-100">
                                    ${mediaHtml}
                                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                                    <div class="absolute top-2 left-2 bg-white/90 p-1.5 rounded-full shadow-sm text-gray-800">
                                        <i data-lucide="${stop.icon}" class="w-4 h-4"></i>
                                    </div>
                                    <div class="absolute bottom-3 right-3 text-white">
                                        <div class="text-lg font-black leading-none shadow-black drop-shadow-md">${stop.title}</div>
                                        <div class="text-xs opacity-90 font-medium mt-1">${stop.subTitle}</div>
                                    </div>
                                </div>

                                <div class="p-3.5 flex justify-between items-center">
                                    <div class="flex items-center gap-1.5 bg-slate-50 px-2 py-1 rounded-md border border-slate-200">
                                        <i data-lucide="clock" class="w-3 h-3 text-slate-500"></i>
                                        <span id="time-${index}" class="text-xs font-bold text-slate-700 font-mono">${stop.displayTime}</span>
                                    </div>
                                    <div id="eta-${index}" class="hidden flex items-center gap-1 text-[10px] font-bold text-green-700 bg-green-50 px-2 py-1 rounded-full border border-green-100 animate-pulse">
                                        <i data-lucide="timer" class="w-3 h-3"></i> <span id="eta-text-${index}"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        ${showGas ? `
                        <div class="ml-4 mr-[30px] my-4 relative">
                            <div class="absolute right-[21px] -top-6 -bottom-6 w-0 border-r-2 border-dashed border-slate-200"></div>
                            <button onclick="openGasModal('${stop.id}')" class="relative w-full bg-white border border-orange-200 rounded-xl p-2 flex items-center gap-3 shadow-sm btn-press transition hover:bg-orange-50">
                                <div class="bg-orange-100 text-orange-600 p-1.5 rounded-lg"><i data-lucide="fuel" class="w-4 h-4"></i></div>
                                <div class="text-right">
                                    <div class="text-xs font-bold text-gray-700">×“×œ×§ ×–×•×œ ×‘×“×¨×š?</div>
                                    <div class="text-[10px] text-gray-400">×œ×—×¥ ×œ×”××œ×¦×•×ª</div>
                                </div>
                            </button>
                        </div>` : ''}
                    </div>
                `;
            });
            lucide.createIcons();
        }

        // --- LIVE TRACKING ---

        function handleMainButton() {
            const btn = document.getElementById('actionBtn');
            const btnText = document.getElementById('btnText');
            const statusMsg = document.getElementById('statusMsg');

            if (!isTracking) {
                if (navigator.geolocation) {
                    btnText.innerText = "×××ª×¨...";
                    statusMsg.classList.remove('hidden');
                    
                    navigator.geolocation.watchPosition(
                        (position) => {
                            isTracking = true;
                            // Fake location for testing (Monterey area):
                            // userLocation = { lat: 36.6, lng: -121.9 };
                            userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                            
                            btn.classList.remove('bg-green-600', 'shadow-green-200');
                            btn.classList.add('bg-blue-600', 'shadow-blue-200');
                            btnText.innerText = "××™×¤×” ×× ×™?";
                            statusMsg.classList.add('hidden');
                            document.getElementById('liveIndicator').classList.remove('hidden');

                            updateLiveLogic();
                        },
                        (err) => {
                            alert("×œ× × ×™×ª×Ÿ ×œ×§×‘×œ ××™×§×•×. ×•×•×“× ×©×”-GPS ×“×œ×•×§ ×‘×“×¤×“×¤×Ÿ.");
                            btnText.innerText = "×”×¤×¢×œ ×–××Ÿ ×××ª";
                            statusMsg.classList.add('hidden');
                        },
                        { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
                    );
                }
            } else {
                scrollToActive();
            }
        }

        function updateLiveLogic() {
            if (!userLocation) return;
            const { lat, lng } = userLocation;
            const now = new Date();
            let activeSegmentIndex = -1;
            let segmentProgress = 0;

            ITINERARY.forEach((stop, idx) => {
                if (stop.type === 'divider') return;

                const dist = getDistance(lat, lng, stop.coords.lat, stop.coords.lng);
                const minutes = Math.round((dist * 1.4 / 70) * 60); 
                
                const timeEl = document.getElementById(`time-${idx}`);
                const etaEl = document.getElementById(`eta-${idx}`);
                const etaTextEl = document.getElementById(`eta-text-${idx}`);
                const dot = document.getElementById(`dot-${idx}`);
                const innerDot = document.getElementById(`inner-dot-${idx}`);
                const card = document.getElementById(`card-${idx}`);

                if (lat > stop.coords.lat + 0.02) { 
                    timeEl.innerText = stop.originalTime;
                    etaEl.classList.add('hidden');
                    dot.classList.remove('border-slate-300'); dot.classList.add('border-blue-500');
                    innerDot.classList.remove('bg-slate-300'); innerDot.classList.add('bg-blue-500');
                    card.classList.remove('ring-2', 'ring-blue-400');
                } else {
                    if (minutes > 0 && minutes < 600) {
                        const arrival = new Date(now.getTime() + minutes * 60000);
                        timeEl.innerText = `${String(arrival.getHours()).padStart(2,'0')}:${String(arrival.getMinutes()).padStart(2,'0')}`;
                        etaEl.classList.remove('hidden');
                        etaTextEl.innerText = `×¢×•×“ ${Math.floor(minutes/60)}:${String(minutes%60).padStart(2,'0')}`;
                    }
                }
            });

            // Find Active Segment
            const stops = ITINERARY.filter(s => s.type !== 'divider');
            for (let i = 0; i < stops.length - 1; i++) {
                const current = stops[i];
                const next = stops[i+1];
                // Check latitude range (approximate for North/South travel)
                if ((lat >= current.coords.lat && lat <= next.coords.lat) || (lat <= current.coords.lat && lat >= next.coords.lat)) {
                    activeSegmentIndex = ITINERARY.findIndex(s => s.id === current.id);
                    const totalDist = Math.abs(next.coords.lat - current.coords.lat);
                    const covered = Math.abs(lat - current.coords.lat);
                    segmentProgress = totalDist > 0 ? covered / totalDist : 0;
                    break;
                }
            }

            document.querySelectorAll('.car-marker').forEach(el => el.style.opacity = '0');
            
            if (activeSegmentIndex !== -1) {
                const activeCar = document.getElementById(`car-${activeSegmentIndex}`);
                const activeCard = document.getElementById(`card-${activeSegmentIndex}`);
                if (activeCar) {
                    activeCar.style.opacity = '1';
                    activeCar.style.top = `${segmentProgress * 100}%`;
                }
                if (activeCard) {
                     activeCard.classList.add('ring-2', 'ring-blue-400', 'ring-offset-2');
                }
                window.currentActiveIndex = activeSegmentIndex;
            }
        }

        function scrollToActive() {
            if (window.currentActiveIndex !== undefined) {
                document.getElementById(`stop-item-${window.currentActiveIndex}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // --- MODALS ---

        function openModal(idx) {
            const stop = ITINERARY[idx];
            const content = document.getElementById('modalContent');
            const modal = document.getElementById('mainModal');
            
            let mediaHtml = stop.isEmoji 
                ? `<div class="w-full h-full bg-gradient-to-br ${stop.bgGradient} flex items-center justify-center text-8xl">${stop.emoji}</div>`
                : `<img src="${stop.image}" class="w-full h-full object-cover">`;

            // HTML for Navigation Buttons
            const navButtons = `
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div class="col-span-2 text-[10px] text-gray-400 uppercase tracking-widest font-bold text-center">× ×™×•×•×˜ ×œ×™×¢×“</div>
                    <button onclick="nav('${stop.coords.lat},${stop.coords.lng}', 'waze')" class="bg-blue-600 text-white py-3 rounded-xl text-sm font-bold shadow-md btn-press flex justify-center items-center gap-2">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/6/67/Waze_2020.svg" class="w-4 h-4 brightness-0 invert"> Waze ×™×¢×“
                    </button>
                    <button onclick="nav('${stop.coords.lat},${stop.coords.lng}', 'google')" class="bg-white text-gray-700 border border-gray-200 py-3 rounded-xl text-sm font-bold shadow-sm btn-press flex justify-center items-center gap-2">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/a/aa/Google_Maps_icon_%282020%29.svg" class="w-4 h-4"> Google
                    </button>
                </div>

                ${stop.parking ? `
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-2 text-[10px] text-gray-400 uppercase tracking-widest font-bold text-center mt-2">× ×™×•×•×˜ ×œ×—× ×™×”</div>
                    <button onclick="nav('${stop.parking.coords.lat},${stop.parking.coords.lng}', 'waze')" class="bg-slate-800 text-white py-3 rounded-xl text-sm font-bold shadow-md btn-press flex justify-center items-center gap-2">
                        <span class="bg-white/20 px-1.5 rounded text-[10px]">P</span> Waze
                    </button>
                    <button onclick="nav('${stop.parking.coords.lat},${stop.parking.coords.lng}', 'google')" class="bg-slate-100 text-slate-700 border border-slate-200 py-3 rounded-xl text-sm font-bold shadow-sm btn-press flex justify-center items-center gap-2">
                        <span class="bg-slate-300 px-1.5 rounded text-[10px] text-slate-700">P</span> Google
                    </button>
                </div>` : ''}
            `;

            content.innerHTML = `
                <div class="relative h-56 shrink-0">
                    ${mediaHtml}
                    <button onclick="closeModal()" class="absolute top-4 left-4 bg-black/30 text-white p-2 rounded-full backdrop-blur btn-press"><i data-lucide="x" class="w-5 h-5"></i></button>
                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent p-5 pt-12">
                        <h2 class="text-white text-2xl font-black leading-tight">${stop.title}</h2>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="bg-white/20 text-white px-2 py-0.5 rounded text-[10px] backdrop-blur font-bold">${stop.displayTime}</span>
                            <span class="text-white/90 text-sm font-medium">${stop.subTitle}</span>
                        </div>
                    </div>
                </div>
                
                <div class="p-5 bg-white grow flex flex-col">
                    
                    <!-- Long Description -->
                    <div class="text-sm text-gray-700 leading-relaxed mb-4">
                        ${stop.longDesc}
                    </div>
                    
                    <!-- Parking Info Box -->
                    ${stop.parking ? `
                    <div class="bg-white border border-gray-100 p-3 rounded-xl shadow-sm flex gap-3 mb-6">
                        <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center font-bold text-lg shrink-0">P</div>
                        <div>
                            <div class="font-bold text-sm text-gray-800">${stop.parking.name}</div>
                            <div class="text-xs text-gray-400">${stop.parking.address}</div>
                            <div class="text-[10px] font-bold text-green-600 bg-green-50 inline-block px-1.5 py-0.5 rounded mt-1 border border-green-100">${stop.parking.cost}</div>
                        </div>
                    </div>` : ''}

                    <!-- Walking Route Button -->
                    ${stop.walkingRoute ? `
                    <button onclick="window.open('${stop.walkingRoute}', '_blank')" class="w-full mb-6 bg-teal-50 text-teal-700 border border-teal-200 py-3 rounded-xl text-sm font-bold flex justify-center items-center gap-2 btn-press shadow-sm">
                        <i data-lucide="footprints" class="w-4 h-4"></i> ××¡×œ×•×œ ×”×œ×™×›×” ××•××œ×¥ (Google)
                    </button>` : ''}

                    <!-- Navigation Grid -->
                    <div class="mt-auto">
                        ${navButtons}
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            lucide.createIcons();
        }

        function openGasModal(id) {
            const list = document.getElementById('gasModalContent');
            const data = GAS_STATIONS[id];
            list.innerHTML = '';
            
            if (data) {
                data.forEach(st => {
                    list.innerHTML += `
                        <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="font-black text-gray-800 text-lg">${st.name}</div>
                                    <div class="text-xs text-gray-400">${st.address}</div>
                                </div>
                                <div class="font-black px-2 py-1 rounded ${st.price.includes('$7') || st.price.includes('---') ?'bg-red-100 text-red-600':'bg-green-100 text-green-700'}">${st.price}</div>
                            </div>
                            ${st.note ? `<div class="text-[10px] bg-orange-50 text-orange-600 px-2 py-1 rounded inline-block border border-orange-100 mb-2 font-bold">${st.note}</div>` : ''}
                            ${st.price !== '---' ? `
                            <button onclick="nav('${st.address}', 'waze')" class="w-full bg-slate-800 text-white py-2.5 rounded-lg text-xs font-bold flex justify-center items-center gap-2 btn-press shadow-md shadow-slate-200">
                                <i data-lucide="navigation" class="w-3 h-3"></i> × ×•×•×˜ ×œ×ª×—× ×”
                            </button>` : ''}
                        </div>`;
                });
            } else {
                list.innerHTML = `<div class="text-center text-gray-400 py-10">××™×Ÿ ××™×“×¢ ×œ××§×˜×¢ ×–×”</div>`;
            }
            document.getElementById('gasModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            lucide.createIcons();
        }

        function closeModal() { document.getElementById('mainModal').classList.add('hidden'); document.body.style.overflow = ''; }
        function closeGasModal() { document.getElementById('gasModal').classList.add('hidden'); document.body.style.overflow = ''; }

        function nav(dest, app) {
            let url = app === 'waze' 
                ? `https://www.waze.com/ul?q=${encodeURIComponent(dest)}&navigate=yes`
                : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(dest)}`;
            window.open(url, '_blank');
        }

        initItinerary();

    </script>
</body>
</html>

