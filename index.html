<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×˜×™×•×œ ×›×‘×™×© 1 - ×’×¨×¡×” ×¡×•×¤×™×ª</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Rubik', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        
        html { scroll-behavior: smooth; }

        /* ×× ×™××¦×™×™×ª ×¨×›×‘ ×¢×“×™× ×” */
        @keyframes carEngine {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-1px) scale(1.02); }
        }
        
        /* ×”××›×•× ×™×ª ×¢×¦××” */
        .car-marker {
            position: absolute;
            right: 12px; /* ××™×§×•× ×¢×œ ×”×§×• */
            z-index: 30;
            transition: top 1s linear, opacity 0.3s ease; /* ×ª× ×•×¢×” ×—×œ×§×” ×××•×“ */
            pointer-events: none;
            opacity: 0; /* ××•×¡×ª×¨ ×›×‘×¨×™×¨×ª ××—×“×œ */
        }
        
        .car-inner {
            background-color: #2563eb; /* Blue-600 */
            padding: 6px;
            border-radius: 9999px;
            border: 3px solid white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            animation: carEngine 2s infinite ease-in-out;
        }

        /* ×”×¡×ª×¨×ª ×¡×¨×’×œ ×’×œ×™×œ×” */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .btn-press { transition: transform 0.1s; }
        .btn-press:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 pb-24">

    <!-- Header Sticky -->
    <div class="fixed top-0 left-0 right-0 bg-white/95 backdrop-blur-md border-b border-gray-200 px-5 py-4 z-40 shadow-sm transition-all">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-black tracking-tight text-blue-700 flex items-center gap-2">
                    <i data-lucide="map" class="text-blue-500 w-5 h-5"></i>
                    ××¡×¢ ×›×‘×™×© 1
                </h1>
                <div class="flex items-center gap-2">
                    <p class="text-xs text-gray-500 font-medium">×œ×•×¡ ×× ×’'×œ×¡ â¬…ï¸ ×¡×Ÿ ×¤×¨× ×¡×™×¡×§×•</p>
                    <span id="liveIndicator" class="hidden flex h-2 w-2 relative">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                </div>
            </div>
            
            <button id="actionBtn" onclick="handleMainButton()" class="btn-press bg-green-600 text-white px-5 py-2.5 rounded-full text-xs font-bold flex items-center gap-2 shadow-lg shadow-green-200 border border-transparent transition-all">
                <i id="btnIcon" data-lucide="navigation" class="w-4 h-4"></i>
                <span id="btnText">×”×¤×¢×œ ×–××Ÿ ×××ª</span>
            </button>
        </div>
        
        <div id="statusMsg" class="hidden text-center mt-2 text-[11px] font-bold text-orange-500 bg-orange-50 py-1 rounded-lg border border-orange-100 max-w-md mx-auto">
            ×××ª×™×Ÿ ×œ×§×œ×™×˜×ª GPS...
        </div>
    </div>

    <!-- Main Container -->
    <div class="max-w-md mx-auto px-5 pt-24 relative min-h-screen">
        
        <!-- Timeline Line -->
        <div class="absolute top-0 bottom-0 right-[29px] w-[3px] bg-gradient-to-b from-blue-500 via-slate-300 to-slate-200 z-0 rounded-full opacity-50"></div>

        <!-- Itinerary Items (Rendered Once) -->
        <div id="itinerary-container"></div>

    </div>

    <!-- Main Modal (Details) -->
    <div id="mainModal" class="fixed inset-0 z-50 hidden flex items-end justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="bg-white w-full max-w-md rounded-t-3xl shadow-2xl animate-[slideIn_0.3s_ease-out] relative z-10 max-h-[90vh] flex flex-col overflow-hidden">
            <div id="modalContent" class="flex flex-col h-full overflow-y-auto no-scrollbar"></div>
        </div>
    </div>

    <!-- Gas Modal -->
    <div id="gasModal" class="fixed inset-0 z-50 hidden flex items-end justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeGasModal()"></div>
        <div class="bg-white w-full max-w-md rounded-t-3xl shadow-2xl relative z-10 max-h-[85vh] flex flex-col">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-orange-50 rounded-t-3xl sticky top-0 z-20">
                <div>
                    <h2 class="text-xl font-black text-orange-600 flex items-center gap-2">
                        <i data-lucide="fuel" class="w-6 h-6"></i> ×“×œ×§ ×–×•×œ ×‘×“×¨×š
                    </h2>
                    <p class="text-xs text-orange-400 font-bold mt-1">×”×ª×—× ×•×ª ×”××©×ª×œ××•×ª ×‘××§×˜×¢ ×–×”</p>
                </div>
                <button onclick="closeGasModal()" class="bg-white text-orange-400 p-2 rounded-full shadow-sm btn-press"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="gasModalContent" class="p-5 space-y-4 overflow-y-auto bg-slate-50 no-scrollbar"></div>
        </div>
    </div>

    <script>
        // --- DATA ---
        
        // ×™×•× 1 + ×™×•× 2 ×ª×—× ×•×ª ×“×œ×§
        const GAS_STATIONS = {
            'start': [ 
                { name: "ARCO Oxnard", address: "1935 N Oxnard Blvd", price: "$4.39", note: "×–×•×œ! ××–×•××Ÿ/Debit ×‘×œ×‘×“" },
                { name: "United Oil", address: "2888 E Thousand Oaks Blvd", price: "$4.45", note: "×¢×œ ×”×“×¨×š" },
                { name: "Valero", address: "500 S Ventura Rd", price: "$4.49", note: "××—×™×¨ ×”×•×’×Ÿ" }
            ],
            'sb': [ 
                { name: "Fuel Depot", address: "5767 Calle Real, Goleta", price: "$4.55", note: "×”×›×™ ×–×•×œ ×‘×™×¦×™××” ××¡× ×˜×” ×‘×¨×‘×¨×”" },
                { name: "ARCO Buellton", address: "175 E Hwy 246", price: "$4.35", note: "×××© ×‘×›× ×™×¡×” ×œ×¡×•×œ×‘× ×’" }
            ],
            'solvang': [ 
                { name: "ARCO Pismo", address: "898 Oak Park Blvd", price: "$4.29", note: "××•××œ×¥ ×œ×¤× ×™ ×©× ×›× ×¡×™× ×œ-Big Sur" },
                { name: "Speedway Express", address: "1350 Grand Ave", price: "$4.35", note: "" }
            ],
            'gas': [ 
                { name: "Morro Bay Fuel", address: "1590 Main St", price: "$4.45", note: "×‘×ª×•×š ×”×¢×™×¨" },
                { name: "Sinclair", address: "940 Morro Bay Blvd", price: "$4.49", note: "×“×™× ×•×–××•×¨ ×™×¨×•×§" }
            ],
            'morro': [ 
                { name: "Chevron Cambria", address: "2194 Main St", price: "$5.89", note: "×™×§×¨! ×¨×§ ×× ×—×™×™×‘×™×" },
                { name: "××–×”×¨×”", address: "×ª××œ××• ×œ×¤× ×™ ×©××’×™×¢×™× ×œ×›××Ÿ!", price: "---", note: "××™×Ÿ ×“×œ×§ ×–×•×œ ×¢×“ ××•× ×˜×¨×™×™" }
            ],
            'seals': [ 
                { name: "Ragged Point", address: "19019 CA-1", price: "$7.99", note: "×—×™×¨×•× ×‘×œ×‘×“ (×™×§×¨ ×‘×˜×™×¨×•×£)" },
                { name: "Gorda Gas", address: "HC 67, Big Sur", price: "$7.50", note: "×—×™×¨×•× ×‘×œ×‘×“" }
            ],
            'monterey': [ // ×™×•× 2 ×‘×‘×•×§×¨
                { name: "Safeway Fuel", address: "104 Canyon Del Rey", price: "$4.25", note: "×”×›×™ ×–×•×œ ×‘××–×•×¨ (×œ×™×“ ×”××œ×•×Ÿ)" },
                { name: "Valero", address: "2200 N Fremont St", price: "$4.39", note: "××—×™×¨ ×˜×•×‘" }
            ],
            'aquarium': [
                { name: "Chevron Carmel", address: "3545 Rio Rd, Carmel", price: "$4.89", note: "×™×§×¨ ×™×—×¡×™×ª, ××‘×œ × ×•×—" },
                { name: "Shell", address: "3745 Via Nona Marie", price: "$4.79", note: "×‘×›× ×™×¡×” ×œ×›×¨××œ" }
            ],
            'carmel': [
                 { name: "××–×”×¨×”", address: "××™×Ÿ ×“×œ×§ ×‘-Big Sur", price: "---", note: "××œ××• ×œ×¤× ×™ ×”× ×¡×™×¢×” ×œ×’×©×¨ ×‘×™×§×¡×‘×™" }
            ],
            'bixby': [ // × ×¡×™×¢×” ×œ×¡×Ÿ ×¤×¨× ×¡×™×¡×§×•
                { name: "Costco Gas (Half Moon Bay)", address: "Hwy 1", price: "$4.15", note: "×œ×—×‘×¨×™ ××•×¢×“×•×Ÿ ×‘×œ×‘×“" },
                { name: "Chevron Pacifica", address: "500 Linda Mar Blvd", price: "$4.65", note: "×œ×¤× ×™ ×”×›× ×™×¡×” ×œ-SF" }
            ]
        };

        const ITINERARY = [
            {
                id: 'start',
                title: '×™×¦×™××”: ×œ×•×¡ ×× ×’\'×œ×¡',
                originalTime: '09:00',
                displayTime: '09:00',
                description: '×™×¦×™××” ×××œ×•×Ÿ Westin Bonaventure. ×œ×•×•×“×: ××™×, ×›×‘×œ×™× ×•× ×©× ×•×©×™×.',
                type: 'start',
                icon: 'car',
                coords: { lat: 34.0528, lng: -118.2556 },
                parking: { name: '×œ×•×‘×™ ×”××œ×•×Ÿ', coords: { lat: 34.0528, lng: -118.2556 }, cost: '---' },
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ3p6yTIcIs92AnFZfplUcSVPCaXzjjpc_hdRUxa4vbcA&s=10"
            },
            {
                id: 'sb',
                title: '×¡× ×˜×” ×‘×¨×‘×¨×”',
                subTitle: 'Stearns Wharf',
                originalTime: '11:00',
                displayTime: '11:00',
                description: '×¢×¦×™×¨×” ×‘××–×— ×”×¢×ª×™×§. ××•×•×™×¨×” ×©×œ ×¨×™×‘×™×™×¨×” ×¡×¤×¨×“×™×ª.',
                type: 'stop',
                icon: 'anchor',
                coords: { lat: 34.4123, lng: -119.6876 }, 
                parking: { name: 'City Lot #1', address: '23 E Cabrillo Blvd', coords: { lat: 34.4137, lng: -119.6905 }, cost: '×—×™× × 75 ×“×§×³, ××—×´×› $2.5/×©×¢×”' },
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSB1m_VYizll6MT567ggSruv9ImG91t4HKdwqXT1wxLWA&s=10"
            },
            {
                id: 'solvang',
                title: '×¡×•×œ×‘× ×’',
                subTitle: '×”×¢×™×™×¨×” ×”×“× ×™×ª',
                originalTime: '12:30',
                displayTime: '12:30',
                description: '×”×¤×¡×§×ª ×¦×”×¨×™×™× ×‘×“× ××¨×§ ×”×§×˜× ×”. ×—×•×‘×” ×œ×˜×¢×•× ×××¤×” ×“× ×™.',
                type: 'stop',
                icon: 'coffee',
                coords: { lat: 34.5958, lng: -120.1376 },
                parking: { name: 'Public Parking', address: '1616 Oak St', coords: { lat: 34.5945, lng: -120.1408 }, cost: '×—×™× ×' },
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS2NgP8pvIZShu5F_1XhFvbqpMI-fDt3sSXwxNpXw4IHg&s=10"
            },
            {
                id: 'gas',
                title: '×ª×“×œ×•×§ ×—×•×‘×”!',
                subTitle: '×¡×Ÿ ×œ×•××™×¡ ××•×‘×™×¡×¤×•',
                originalTime: '14:30',
                displayTime: '14:30',
                description: '× ×§×•×“×” ×§×¨×™×˜×™×ª! ××›××Ÿ ××™×Ÿ ×“×œ×§ × ×•×¨××œ×™ ×œ×©×¢×•×ª ×”×§×¨×•×‘×•×ª.',
                type: 'gas',
                icon: 'fuel',
                coords: { lat: 35.2675, lng: -120.6481 },
                parking: { name: 'Conserv Fuel', address: '2211 Broad St', coords: { lat: 35.2675, lng: -120.6481 }, cost: '×œ×œ×§×•×—×•×ª ×‘×œ×‘×“' },
                isEmoji: true, emoji: "â›½", bgGradient: "from-orange-400 to-red-500"
            },
            {
                id: 'morro',
                title: '××•×¨×• ×‘×™×™',
                subTitle: 'Morro Rock',
                originalTime: '15:00',
                displayTime: '15:00',
                description: '×ª××•× ×” ×–×¨×™×–×” ×¢× ×”×¡×œ×¢ ×”×’×¢×©×™ ×©×‘×•×§×¢ ××”×™×.',
                type: 'stop',
                icon: 'camera',
                coords: { lat: 35.3712, lng: -120.8667 },
                parking: { name: 'Coleman Park', address: 'Coleman Dr', coords: { lat: 35.3705, lng: -120.8650 }, cost: '×—×™× ×' },
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQNR-4naNKMPmIiq99YbgSSK0VvTVhUrTG-W_7YMbSYOg&s=10"
            },
            {
                id: 'seals',
                title: '×¤×™×œ×™ ×”×™×',
                subTitle: 'San Simeon',
                originalTime: '16:15',
                displayTime: '16:15',
                description: '×”×©×™× ×©×œ ×”× ×¡×™×¢×”! ××œ×¤×™ ×¤×™×œ×™ ×™× ×¢×œ ×”×—×•×£.',
                type: 'stop',
                icon: 'fish',
                coords: { lat: 35.6630, lng: -121.2575 },
                parking: { name: 'Vista Point', address: 'Hwy 1', coords: { lat: 35.6630, lng: -121.2575 }, cost: '×—×™× ×' },
                isEmoji: true, emoji: "ğŸ¦­", bgGradient: "from-blue-400 to-cyan-600"
            },
            {
                id: 'monterey',
                title: '×”×’×¢×” ×œ××œ×•×Ÿ',
                subTitle: 'Victorian Inn',
                originalTime: '18:30',
                displayTime: '18:30',
                description: '×¡×™×•× ×™×•× 1. ××¨×—×§ ×”×œ×™×›×” ×-Cannery Row.',
                type: 'hotel',
                icon: 'bed',
                coords: { lat: 36.6128, lng: -121.9001 },
                parking: { name: '×—× ×™×•×Ÿ ×”××œ×•×Ÿ', address: '487 Foam St', coords: { lat: 36.6128, lng: -121.9001 }, cost: '$20 ×œ×œ×™×œ×” (×‘×¢×¨×š)' },
                isEmoji: true, emoji: "ğŸ¨", bgGradient: "from-indigo-500 to-purple-600"
            },
            { id: 'day2', title: '×™×•× ×©× ×™ (02/02)', type: 'divider' },
            {
                id: 'aquarium',
                title: '××§×•×•×¨×™×•× ××•× ×˜×¨×™×™',
                subTitle: 'Cannery Row',
                originalTime: '09:00',
                displayTime: '09:00',
                description: '××”×˜×•×‘×™× ×‘×¢×•×œ×. ×œ×”×–××™×Ÿ ×›×¨×˜×™×¡×™× ××¨××©.',
                type: 'stop',
                icon: 'fish',
                coords: { lat: 36.6183, lng: -121.9015 },
                parking: { name: 'Cannery Row Garage', address: '601 Foam St', coords: { lat: 36.6145, lng: -121.8988 }, cost: '$20-$30 ×œ×™×•×' },
                image: "https://media-cdn.tripadvisor.com/media/photo-s/12/e8/d0/6c/back-decks-and-great.jpg"
            },
            {
                id: 'carmel',
                title: '×›×¨××œ',
                subTitle: 'Carmel-by-the-Sea',
                originalTime: '11:30',
                displayTime: '11:30',
                description: '×¢×™×™×¨×” ×¦×™×•×¨×™×ª ×•×—×•×£ ×œ×‘×Ÿ ××”××.',
                type: 'stop',
                icon: 'coffee',
                coords: { lat: 36.5552, lng: -121.9233 },
                parking: { name: 'Vista Lobos', address: '3rd Ave & Torres St', coords: { lat: 36.5560, lng: -121.9215 }, cost: '×—×™× ×' },
                image: "https://dynamic-media-cdn.tripadvisor.com/media/photo-o/0a/66/e2/75/20160221-091502-1-largejpg.jpg?w=600&h=-1&s=1"
            },
            {
                id: 'bixby',
                title: '×’×©×¨ ×‘×™×§×¡×‘×™',
                subTitle: 'Big Sur Bridge',
                originalTime: '13:20',
                displayTime: '13:20',
                description: '×”×ª××•× ×” ×”××¤×•×¨×¡××ª ×‘×™×•×ª×¨. ×–×”×™×¨×•×ª ×‘×—×¦×™×™×”.',
                type: 'stop',
                icon: 'camera',
                coords: { lat: 36.3714, lng: -121.9017 },
                parking: { name: '××¤×¨×¥ ×¦×¤×•× ×™', address: 'Hwy 1', coords: { lat: 36.3725, lng: -121.9030 }, cost: '×—×™× ×' },
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ2zJIDl1fe1ZGo7UfUrx2iHn1dYXzNNPtTfggtnUme6A&s=10"
            },
            {
                id: 'sf',
                title: '×¡×™×•×: ×¡×Ÿ ×¤×¨× ×¡×™×¡×§×•',
                subTitle: 'Fisherman\'s Wharf',
                originalTime: '17:00',
                displayTime: '17:00',
                description: '×”×’×¢×” ×œ×¢×™×¨ ×”×’×“×•×œ×” ×•×”×—×–×¨×ª ×”×¨×›×‘.',
                type: 'stop',
                icon: 'anchor',
                coords: { lat: 37.8080, lng: -122.4177 },
                parking: { name: '×—× ×™×•×Ÿ ×”××œ×•×Ÿ', coords: { lat: 37.8080, lng: -122.4177 }, cost: '$50-$70 ×œ×œ×™×œ×”' },
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcThRZsv_ufgRrqGw4E1tFyxdTSwAQoAxAfQGk5jrZAlaTvcZzTjQ3fM_-J5&s=10"
            }
        ];

        // --- STATE & UTILS ---
        let isTracking = false;
        let userLocation = null;
        let etas = {};

        function deg2rad(deg) { return deg * (Math.PI/180); }
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // --- CORE LOGIC ---

        // ×‘× ×™×” ×—×“ ×¤×¢××™×ª ×©×œ ×”-HTML ×œ×× ×™×¢×ª ×”×‘×”×•×‘
        function initItinerary() {
            const container = document.getElementById('itinerary-container');
            container.innerHTML = '';

            ITINERARY.forEach((stop, index) => {
                // Divider
                if (stop.type === 'divider') {
                    container.innerHTML += `
                        <div class="relative z-10 my-8 flex items-center justify-center">
                            <span class="bg-slate-800 text-white px-4 py-1 rounded-full text-xs font-bold shadow-md tracking-wide">
                                ${stop.title}
                            </span>
                        </div>`;
                    return;
                }

                const showGas = index < ITINERARY.length - 1 && ITINERARY[index+1].type !== 'divider' && GAS_STATIONS[stop.id];

                // Image/Emoji
                let mediaHtml = stop.isEmoji 
                    ? `<div class="w-full h-full bg-gradient-to-br ${stop.bgGradient} flex items-center justify-center text-6xl drop-shadow-md select-none">${stop.emoji}</div>`
                    : `<img src="${stop.image}" class="w-full h-full object-cover select-none">`;

                // Main Item HTML
                container.innerHTML += `
                    <div id="stop-item-${index}" class="relative mb-8">
                        
                        <!-- THE CAR ELEMENT (Hidden by default, opacity 0) -->
                        <div id="car-${index}" class="car-marker" style="top: 0%;">
                            <div class="car-inner">
                                <i data-lucide="car" class="w-4 h-4 text-white"></i>
                            </div>
                        </div>

                        <div class="flex items-start gap-4">
                            <!-- Timeline Dot -->
                            <div id="dot-${index}" class="relative shrink-0 w-8 h-8 rounded-full border-[3px] z-10 flex items-center justify-center bg-white shadow-sm mt-8 transition-colors duration-500 border-slate-300">
                                <div id="inner-dot-${index}" class="w-2.5 h-2.5 rounded-full transition-colors duration-500 bg-slate-300"></div>
                            </div>

                            <!-- Card -->
                            <div id="card-${index}" onclick="openModal(${index})" class="relative grow bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden cursor-pointer btn-press transition-all duration-300">
                                <div class="h-32 w-full relative bg-gray-100">
                                    ${mediaHtml}
                                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                                    <div class="absolute top-2 left-2 bg-white/90 p-1.5 rounded-full shadow-sm text-gray-800">
                                        <i data-lucide="${stop.icon}" class="w-4 h-4"></i>
                                    </div>
                                    <div class="absolute bottom-3 right-3 text-white">
                                        <div class="text-lg font-black leading-none shadow-black drop-shadow-md">${stop.title}</div>
                                        <div class="text-xs opacity-90 font-medium mt-1">${stop.subTitle}</div>
                                    </div>
                                </div>

                                <div class="p-3.5 flex justify-between items-center">
                                    <div class="flex items-center gap-1.5 bg-slate-50 px-2 py-1 rounded-md border border-slate-200">
                                        <i data-lucide="clock" class="w-3 h-3 text-slate-500"></i>
                                        <span id="time-${index}" class="text-xs font-bold text-slate-700 font-mono">${stop.displayTime}</span>
                                    </div>

                                    <!-- ETA Badge (Dynamic) -->
                                    <div id="eta-${index}" class="hidden flex items-center gap-1 text-[10px] font-bold text-green-700 bg-green-50 px-2 py-1 rounded-full border border-green-100 animate-pulse">
                                        <i data-lucide="timer" class="w-3 h-3"></i> <span id="eta-text-${index}"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gas Button -->
                        ${showGas ? `
                        <div class="ml-4 mr-[30px] my-4 relative">
                            <div class="absolute right-[21px] -top-6 -bottom-6 w-0 border-r-2 border-dashed border-slate-200"></div>
                            <button onclick="openGasModal('${stop.id}')" class="relative w-full bg-white border border-orange-200 rounded-xl p-2 flex items-center gap-3 shadow-sm btn-press transition hover:bg-orange-50">
                                <div class="bg-orange-100 text-orange-600 p-1.5 rounded-lg"><i data-lucide="fuel" class="w-4 h-4"></i></div>
                                <div class="text-right">
                                    <div class="text-xs font-bold text-gray-700">×“×œ×§ ×–×•×œ ×‘×“×¨×š?</div>
                                    <div class="text-[10px] text-gray-400">×œ×—×¥ ×œ×”××œ×¦×•×ª</div>
                                </div>
                            </button>
                        </div>` : ''}
                    </div>
                `;
            });
            lucide.createIcons();
        }

        // ×›×¤×ª×•×¨ ×¨××©×™
        function handleMainButton() {
            const btn = document.getElementById('actionBtn');
            const btnText = document.getElementById('btnText');
            const statusMsg = document.getElementById('statusMsg');

            if (!isTracking) {
                if (navigator.geolocation) {
                    btnText.innerText = "×××ª×¨...";
                    statusMsg.classList.remove('hidden');
                    
                    navigator.geolocation.watchPosition(
                        (position) => {
                            isTracking = true;
                            // Fake location for testing (uncomment to simulate being near Santa Barbara):
                            // userLocation = { lat: 34.3, lng: -119.5 };
                            userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                            
                            // Visual Updates
                            btn.classList.remove('bg-green-600', 'shadow-green-200');
                            btn.classList.add('bg-blue-600', 'shadow-blue-200');
                            btnText.innerText = "××™×¤×” ×× ×™?";
                            statusMsg.classList.add('hidden');
                            document.getElementById('liveIndicator').classList.remove('hidden');

                            updateLiveLogic();
                        },
                        (err) => {
                            alert("×œ× × ×™×ª×Ÿ ×œ×§×‘×œ ××™×§×•×. ×•×•×“× ×©×”-GPS ×“×œ×•×§ ×‘×“×¤×“×¤×Ÿ.");
                            btnText.innerText = "×”×¤×¢×œ ×–××Ÿ ×××ª";
                            statusMsg.classList.add('hidden');
                        },
                        { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
                    );
                }
            } else {
                scrollToActive();
            }
        }

        // ×œ×•×’×™×§×” ×©×¨×¦×” ×‘×›×œ ×¢×“×›×•×Ÿ GPS
        function updateLiveLogic() {
            if (!userLocation) return;
            const { lat, lng } = userLocation;
            const now = new Date();
            let activeSegmentIndex = -1;
            let segmentProgress = 0;

            const stops = ITINERARY.filter(s => s.type !== 'divider');

            // 1. Find Location & Calculate ETA
            ITINERARY.forEach((stop, idx) => {
                if (stop.type === 'divider') return;

                // Update Time Logic
                const dist = getDistance(lat, lng, stop.coords.lat, stop.coords.lng);
                const minutes = Math.round((dist * 1.4 / 70) * 60); 
                
                // DOM Elements
                const timeEl = document.getElementById(`time-${idx}`);
                const etaEl = document.getElementById(`eta-${idx}`);
                const etaTextEl = document.getElementById(`eta-text-${idx}`);
                const dot = document.getElementById(`dot-${idx}`);
                const innerDot = document.getElementById(`inner-dot-${idx}`);
                const card = document.getElementById(`card-${idx}`);

                // Past or Future?
                // Simple logic: if we are significantly North of the stop
                if (lat > stop.coords.lat + 0.02) { 
                    // Past
                    timeEl.innerText = stop.originalTime;
                    etaEl.classList.add('hidden');
                    
                    // Style Updates (Past)
                    dot.classList.remove('border-slate-300'); dot.classList.add('border-blue-500');
                    innerDot.classList.remove('bg-slate-300'); innerDot.classList.add('bg-blue-500');
                    card.classList.remove('ring-2', 'ring-blue-400');
                } else {
                    // Future
                    if (minutes > 0 && minutes < 600) { // Limit crazy values
                        const arrival = new Date(now.getTime() + minutes * 60000);
                        timeEl.innerText = `${String(arrival.getHours()).padStart(2,'0')}:${String(arrival.getMinutes()).padStart(2,'0')}`;
                        etaEl.classList.remove('hidden');
                        etaTextEl.innerText = `×¢×•×“ ${Math.floor(minutes/60)}:${String(minutes%60).padStart(2,'0')}`;
                    }
                }
            });

            // 2. Determine Active Segment (Where is the car?)
            for (let i = 0; i < stops.length - 1; i++) {
                const current = stops[i];
                const next = stops[i+1];
                
                // If we are strictly between these two latitudes
                if (lat >= current.coords.lat && lat <= next.coords.lat) {
                    // Find original index in full ITINERARY
                    activeSegmentIndex = ITINERARY.findIndex(s => s.id === current.id);
                    
                    const totalDist = next.coords.lat - current.coords.lat;
                    const covered = lat - current.coords.lat;
                    segmentProgress = covered / totalDist; // 0.0 to 1.0
                    break;
                }
            }

            // 3. Move the Car (Visual Only - No re-render)
            // Reset all cars first
            document.querySelectorAll('.car-marker').forEach(el => el.style.opacity = '0');
            
            if (activeSegmentIndex !== -1) {
                const activeCar = document.getElementById(`car-${activeSegmentIndex}`);
                const activeCard = document.getElementById(`card-${activeSegmentIndex}`);
                
                if (activeCar) {
                    activeCar.style.opacity = '1';
                    // Move it! (CSS transition handles smooth slide)
                    // We add a slight offset (20px) to not overlap the dot immediately
                    activeCar.style.top = `${segmentProgress * 100}%`;
                }
                
                if (activeCard) {
                     activeCard.classList.add('ring-2', 'ring-blue-400', 'ring-offset-2');
                }
                
                // Save global active for scroll button
                window.currentActiveIndex = activeSegmentIndex;
            }
        }

        function scrollToActive() {
            if (window.currentActiveIndex !== undefined) {
                document.getElementById(`stop-item-${window.currentActiveIndex}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // --- MODALS ---

        function openModal(idx) {
            const stop = ITINERARY[idx];
            const content = document.getElementById('modalContent');
            const modal = document.getElementById('mainModal');
            
            let mediaHtml = stop.isEmoji 
                ? `<div class="w-full h-full bg-gradient-to-br ${stop.bgGradient} flex items-center justify-center text-8xl">${stop.emoji}</div>`
                : `<img src="${stop.image}" class="w-full h-full object-cover">`;

            content.innerHTML = `
                <div class="relative h-56 shrink-0">
                    ${mediaHtml}
                    <button onclick="closeModal()" class="absolute top-4 left-4 bg-black/30 text-white p-2 rounded-full backdrop-blur btn-press"><i data-lucide="x" class="w-5 h-5"></i></button>
                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent p-5 pt-12">
                        <h2 class="text-white text-2xl font-black leading-tight">${stop.title}</h2>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="bg-white/20 text-white px-2 py-0.5 rounded text-[10px] backdrop-blur font-bold">${stop.displayTime}</span>
                            <span class="text-white/90 text-sm font-medium">${stop.subTitle}</span>
                        </div>
                    </div>
                </div>
                <div class="p-5 bg-white grow flex flex-col">
                    <p class="text-sm text-gray-600 leading-relaxed bg-gray-50 p-3 rounded-xl border border-gray-100 mb-4">${stop.description}</p>
                    
                    ${stop.parking ? `
                    <div class="bg-white border border-gray-100 p-3 rounded-xl shadow-sm flex gap-3 mb-6">
                        <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center font-bold text-lg shrink-0">P</div>
                        <div>
                            <div class="font-bold text-sm text-gray-800">${stop.parking.name}</div>
                            <div class="text-xs text-gray-400">${stop.parking.address}</div>
                            <div class="text-[10px] font-bold text-green-600 bg-green-50 inline-block px-1.5 py-0.5 rounded mt-1 border border-green-100">${stop.parking.cost}</div>
                        </div>
                    </div>` : ''}

                    <div class="grid grid-cols-2 gap-3 mt-auto mb-4">
                        <button onclick="nav('${stop.coords.lat},${stop.coords.lng}', 'waze')" class="bg-blue-600 text-white py-3.5 rounded-xl text-sm font-bold shadow-lg shadow-blue-200 btn-press flex justify-center items-center gap-2">
                            <i data-lucide="navigation" class="w-4 h-4"></i> ×¡×¢ ×œ×™×¢×“
                        </button>
                        <button onclick="nav('${stop.parking ? stop.parking.address : stop.coords.lat + ',' + stop.coords.lng}', 'google')" class="bg-gray-100 text-gray-800 py-3.5 rounded-xl text-sm font-bold border border-gray-200 btn-press flex justify-center items-center gap-2">
                            <i data-lucide="map" class="w-4 h-4"></i> ×’×•×’×œ ××¤×¡
                        </button>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            lucide.createIcons();
        }

        function openGasModal(id) {
            const list = document.getElementById('gasModalContent');
            const data = GAS_STATIONS[id];
            list.innerHTML = '';
            
            if (data) {
                data.forEach(st => {
                    list.innerHTML += `
                        <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="font-black text-gray-800 text-lg">${st.name}</div>
                                    <div class="text-xs text-gray-400">${st.address}</div>
                                </div>
                                <div class="font-black px-2 py-1 rounded ${st.price.includes('$7') || st.price.includes('---') ?'bg-red-100 text-red-600':'bg-green-100 text-green-700'}">${st.price}</div>
                            </div>
                            ${st.note ? `<div class="text-[10px] bg-orange-50 text-orange-600 px-2 py-1 rounded inline-block border border-orange-100 mb-2 font-bold">${st.note}</div>` : ''}
                            ${st.price !== '---' ? `
                            <button onclick="nav('${st.address}', 'waze')" class="w-full bg-slate-800 text-white py-2.5 rounded-lg text-xs font-bold flex justify-center items-center gap-2 btn-press shadow-md shadow-slate-200">
                                <i data-lucide="navigation" class="w-3 h-3"></i> × ×•×•×˜ ×œ×ª×—× ×”
                            </button>` : ''}
                        </div>`;
                });
            } else {
                list.innerHTML = `<div class="text-center text-gray-400 py-10">××™×Ÿ ××™×“×¢ ×œ××§×˜×¢ ×–×”</div>`;
            }
            document.getElementById('gasModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            lucide.createIcons();
        }

        function closeModal() { document.getElementById('mainModal').classList.add('hidden'); document.body.style.overflow = ''; }
        function closeGasModal() { document.getElementById('gasModal').classList.add('hidden'); document.body.style.overflow = ''; }

        function nav(dest, app) {
            let url = app === 'waze' 
                ? `https://www.waze.com/ul?q=${encodeURIComponent(dest)}&navigate=yes`
                : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(dest)}`;
            window.open(url, '_blank');
        }

        // Initialize App
        initItinerary();

    </script>
</body>
</html>

