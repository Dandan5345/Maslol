<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×˜×™×•×œ ×›×‘×™×© 1 - ×”××“×¨×™×š ×”××œ×</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Rubik', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Smooth scrolling */
        html { scroll-behavior: smooth; }

        /* Hide Scrollbar but allow scrolling */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animations */
        @keyframes carMove {
            0% { transform: translateY(0); }
            50% { transform: translateY(-2px); }
            100% { transform: translateY(0); }
        }
        .car-bounce { animation: carMove 1s infinite ease-in-out; }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(2); opacity: 0; }
        }
        .gps-pulse::before {
            content: '';
            position: absolute;
            left: 0; top: 0; right: 0; bottom: 0;
            border-radius: 50%;
            background-color: #22c55e;
            z-index: -1;
            animation: pulse-ring 2s infinite;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 pb-20">

    <!-- Header -->
    <div class="fixed top-0 left-0 right-0 bg-white/90 backdrop-blur-md border-b border-gray-200 p-4 z-40 shadow-sm transition-all">
        <div class="max-w-md mx-auto flex flex-col gap-3">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-black tracking-tight text-blue-700 flex items-center gap-2">
                        <i data-lucide="compass" class="text-blue-500 w-5 h-5"></i>
                        ××¡×¢ ×›×‘×™×© 1
                    </h1>
                    <p class="text-xs text-gray-500 font-medium">×œ×•×¡ ×× ×’'×œ×¡ â¬…ï¸ ×¡×Ÿ ×¤×¨× ×¡×™×¡×§×•</p>
                </div>
                
                <button id="trackBtn" onclick="toggleTracking()" class="bg-green-600 active:bg-green-700 text-white px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2 shadow-lg shadow-green-200 transition-transform active:scale-95">
                    <i data-lucide="navigation" class="w-3 h-3"></i>
                    <span id="trackBtnText">×”×¤×¢×œ ×–××Ÿ ×××ª</span>
                </button>
            </div>
            
            <div id="gpsStatus" class="hidden text-[10px] text-orange-600 bg-orange-50 px-2 py-1 rounded text-center font-bold border border-orange-100">
                ×××ª×™×Ÿ ×œ×§×œ×™×˜×ª GPS...
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="max-w-md mx-auto px-5 pt-28 relative min-h-screen">
        
        <!-- Timeline Line -->
        <div class="absolute top-0 bottom-0 right-[29px] w-[3px] bg-slate-200 z-0 rounded-full"></div>

        <!-- Dynamic Content will be injected here -->
        <div id="itinerary-container"></div>

    </div>

    <!-- Main Modal (Stop Details) -->
    <div id="mainModal" class="fixed inset-0 z-50 hidden flex items-end justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="bg-white w-full max-w-md rounded-t-3xl shadow-2xl animate-[slideIn_0.3s_ease-out] relative z-10 max-h-[90vh] flex flex-col">
            <!-- Modal Content Injected Here -->
            <div id="modalContent" class="flex flex-col h-full"></div>
        </div>
    </div>

    <!-- Gas Modal -->
    <div id="gasModal" class="fixed inset-0 z-50 hidden flex items-end justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeGasModal()"></div>
        <div class="bg-white w-full max-w-md rounded-t-3xl shadow-2xl relative z-10 max-h-[85vh] flex flex-col">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-orange-50 rounded-t-3xl">
                <div>
                    <h2 class="text-xl font-black text-orange-600 flex items-center gap-2">
                        <i data-lucide="fuel" class="w-6 h-6"></i> ×“×œ×§ ×–×•×œ ×‘×“×¨×š
                    </h2>
                    <p class="text-xs text-orange-400 font-bold mt-1">×”×ª×—× ×•×ª ×”××©×ª×œ××•×ª ×‘××§×˜×¢ ×–×”</p>
                </div>
                <button onclick="closeGasModal()" class="bg-white text-orange-400 p-2 rounded-full shadow-sm"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="gasModalContent" class="p-5 space-y-4 overflow-y-auto bg-slate-50"></div>
        </div>
    </div>

    <!-- JavaScript Application Logic -->
    <script>
        // --- DATA ---
        
        const GAS_STATIONS_DATA = {
            'start': [ 
                { name: "ARCO", address: "1935 N Oxnard Blvd, Oxnard", price: "$4.39", note: "×–×•×œ ×××•×“, ××–×•××Ÿ/Debit ×‘×œ×‘×“" },
                { name: "United Oil", address: "2888 E Thousand Oaks Blvd", price: "$4.45", note: "×ª×—× ×” ×’×“×•×œ×” ×¢×œ ×”×“×¨×š" },
                { name: "Valero", address: "500 S Ventura Rd, Oxnard", price: "$4.49", note: "××—×™×¨ ×”×•×’×Ÿ" }
            ],
            'sb': [ 
                { name: "Fuel Depot", address: "5767 Calle Real, Goleta", price: "$4.55", note: "×”×›×™ ×–×•×œ ×‘×™×¦×™××” ××¡× ×˜×” ×‘×¨×‘×¨×”" },
                { name: "ARCO", address: "175 E Hwy 246, Buellton", price: "$4.35", note: "×××© ×‘×›× ×™×¡×” ×œ×¡×•×œ×‘× ×’" },
                { name: "Conserv Fuel", address: "150 S La Cumbre Rd", price: "$4.59", note: "" }
            ],
            'solvang': [ 
                { name: "ARCO", address: "898 Oak Park Blvd, Pismo Beach", price: "$4.29", note: "×ª×“×œ×•×§ ××¢×•×œ×” ×œ×¤× ×™ SLO" },
                { name: "Speedway Express", address: "1350 Grand Ave, Arroyo Grande", price: "$4.35", note: "" },
                { name: "Chevron", address: "460 W Tefft St, Nipomo", price: "$4.65", note: "××™×›×•×ª×™ ××š ×™×§×¨ ×™×•×ª×¨" }
            ],
            'gas': [ 
                { name: "Morro Bay Fuel", address: "1590 Main St, Morro Bay", price: "$4.45", note: "×‘×ª×•×š ×”×¢×™×¨" },
                { name: "Sinclair", address: "940 Morro Bay Blvd", price: "$4.49", note: "××—×™×¨ ×¡×‘×‘×”" },
                { name: "Mobil", address: "911 Morro Bay Blvd", price: "$4.69", note: "" }
            ],
            'morro': [ 
                { name: "Chevron Cambria", address: "2194 Main St, Cambria", price: "$5.89", note: "×™×§×¨! ×œ×ª×“×œ×§ ×¨×§ ×× ×—×™×™×‘×™×" },
                { name: "××–×”×¨×”", address: "×ª×“×œ×§×• ×‘××•×¨×• ×‘×™×™!", price: "---", note: "××™×Ÿ ×ª×—× ×•×ª ×–×•×œ×•×ª ×‘×§×˜×¢ ×”×–×”" }
            ],
            'seals': [ 
                { name: "Ragged Point", address: "19019 CA-1", price: "$7.99", note: "×—×™×¨×•× ×‘×œ×‘×“! ×”×™×§×¨ ×‘×§×œ×™×¤×•×¨× ×™×”" },
                { name: "Gorda Gas", address: "HC 67, Big Sur", price: "$7.50", note: "×—×™×¨×•× ×‘×œ×‘×“" }
            ],
            'monterey': [ 
                { name: "Safeway Fuel", address: "104 Canyon Del Rey, Del Rey Oaks", price: "$4.25", note: "×œ×¨×•×‘ ×”×›×™ ×–×•×œ ×‘××™×–×•×¨" },
                { name: "Valero", address: "2200 N Fremont St, Monterey", price: "$4.39", note: "××—×™×¨ ×˜×•×‘" }
            ]
        };

        const ITINERARY = [
            {
                id: 'start',
                title: '×™×¦×™××”: ×œ×•×¡ ×× ×’\'×œ×¡',
                timeBase: '09:00',
                description: '×™×¦×™××” ×××œ×•×Ÿ Westin Bonaventure. ×•×•×“××• ×©×™×© ××™×, ×›×‘×œ×™× ×œ×˜×œ×¤×•×Ÿ ×•× ×©× ×•×©×™× ×œ×“×¨×š!',
                type: 'start',
                icon: 'car',
                coords: { lat: 34.0528, lng: -118.2556 },
                parking: { name: '×œ×•×‘×™ ×”××œ×•×Ÿ (×™×¦×™××”)', coords: { lat: 34.0528, lng: -118.2556 }, cost: '---' },
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ3p6yTIcIs92AnFZfplUcSVPCaXzjjpc_hdRUxa4vbcA&s=10"
            },
            {
                id: 'sb',
                title: '×¡× ×˜×” ×‘×¨×‘×¨×”',
                subTitle: 'Stearns Wharf',
                timeBase: '11:00',
                description: '×¢×¦×™×¨×” ×§×œ××¡×™×ª. ××•××œ×¥ ×œ×—× ×•×ª ×•×œ×œ×›×ª ×œ××–×— ×”×¢×¥ ×”×¢×ª×™×§. ××•×•×™×¨×” ×©×œ ×¨×™×‘×™×™×¨×”.',
                type: 'stop',
                icon: 'anchor',
                coords: { lat: 34.4123, lng: -119.6876 }, 
                parking: { name: '×—× ×™×•×Ÿ ×”××–×— (City Lot #1)', address: '23 E Cabrillo Blvd', coords: { lat: 34.4137, lng: -119.6905 }, cost: '×—×™× × ×œ-75 ×“×§×³' },
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSB1m_VYizll6MT567ggSruv9ImG91t4HKdwqXT1wxLWA&s=10"
            },
            {
                id: 'solvang',
                title: '×¡×•×œ×‘× ×’',
                subTitle: '×”×¢×™×™×¨×” ×”×“× ×™×ª',
                timeBase: '12:30',
                description: '×”×¤×¡×§×ª ×¦×”×¨×™×™×. ×œ×”×¨×’×™×© ×‘××™×¨×•×¤×” ×‘×××¦×¢ ×§×œ×™×¤×•×¨× ×™×”. ×—×•×‘×” ×œ×˜×¢×•× ×××¤×” ×“× ×™.',
                type: 'stop',
                icon: 'coffee',
                coords: { lat: 34.5958, lng: -120.1376 },
                parking: { name: 'Solvang Public Parking', address: '1616 Oak St', coords: { lat: 34.5945, lng: -120.1408 }, cost: '×—×™× ×' },
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS2NgP8pvIZShu5F_1XhFvbqpMI-fDt3sSXwxNpXw4IHg&s=10"
            },
            {
                id: 'gas',
                title: '×ª×“×œ×•×§ ×—×•×‘×”!',
                subTitle: '×¡×Ÿ ×œ×•××™×¡ ××•×‘×™×¡×¤×•',
                timeBase: '14:30',
                description: '× ×§×•×“×” ×§×¨×™×˜×™×ª. ××›××Ÿ ×•×”×œ××” ××™×Ÿ ×ª×—× ×•×ª ×“×œ×§ × ×•×¨××œ×™×•×ª ×œ××©×š ×©×¢×•×ª. ××œ××• ××™×›×œ ××œ×!',
                type: 'gas',
                icon: 'fuel',
                coords: { lat: 35.2675, lng: -120.6481 },
                parking: { name: '×ª×—× ×ª Conserv Fuel', address: '2211 Broad St', coords: { lat: 35.2675, lng: -120.6481 }, cost: '××—×™×¨ ×”×•×’×Ÿ' },
                isEmoji: true, emoji: "â›½", bgGradient: "from-orange-400 to-red-500"
            },
            {
                id: 'morro',
                title: '××•×¨×• ×‘×™×™',
                subTitle: 'Morro Rock',
                timeBase: '15:00',
                description: '×¢×¦×™×¨×” ×§×¦×¨×” ×œ×ª××•× ×” ×¢× ×”×¡×œ×¢ ×”×’×¢×©×™ ×”×¢×¦×•× ×©×‘×•×§×¢ ××”×™×.',
                type: 'stop',
                icon: 'camera',
                coords: { lat: 35.3712, lng: -120.8667 },
                parking: { name: '×—× ×™×•×Ÿ ×”×—×•×£ (Coleman Park)', address: 'Coleman Dr', coords: { lat: 35.3705, lng: -120.8650 }, cost: '×—×™× ×' },
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQNR-4naNKMPmIiq99YbgSSK0VvTVhUrTG-W_7YMbSYOg&s=10"
            },
            {
                id: 'seals',
                title: '×¤×™×œ×™ ×”×™×',
                subTitle: 'San Simeon',
                timeBase: '16:15',
                description: '×”×©×™× ×©×œ ×”× ×¡×™×¢×”! ××œ×¤×™ ×¤×™×œ×™ ×™× ×¨×•×‘×¦×™× ×¢×œ ×”×—×•×£. ×¨×¢×© ×•×¨×™×— ×©×œ× ×©×•×›×—×™×.',
                type: 'stop',
                icon: 'fish',
                coords: { lat: 35.6630, lng: -121.2575 },
                parking: { name: '×—× ×™×•×Ÿ ×”×ª×¦×¤×™×ª', address: 'Hwy 1 Vista Point', coords: { lat: 35.6630, lng: -121.2575 }, cost: '×—×™× ×' },
                isEmoji: true, emoji: "ğŸ¦­", bgGradient: "from-blue-400 to-cyan-600"
            },
            {
                id: 'monterey',
                title: '×”×’×¢×” ×œ××œ×•×Ÿ',
                subTitle: 'Victorian Inn',
                timeBase: '18:30',
                description: '×¡×™×•× ×”×™×•× ×”×¨××©×•×Ÿ. ×”××œ×•×Ÿ × ××¦× ×‘××¨×—×§ ×”×œ×™×›×” ×-Cannery Row.',
                type: 'hotel',
                icon: 'bed',
                coords: { lat: 36.6128, lng: -121.9001 },
                parking: { name: '×—× ×™×•×Ÿ ×”××œ×•×Ÿ', address: '487 Foam St', coords: { lat: 36.6128, lng: -121.9001 }, cost: '×œ××•×¨×—×™ ×”××œ×•×Ÿ' },
                isEmoji: true, emoji: "ğŸ¨", bgGradient: "from-indigo-500 to-purple-600"
            },
            { id: 'day2', title: '×™×•× ×©× ×™ (02/02)', type: 'divider' },
            {
                id: 'aquarium',
                title: '××§×•×•×¨×™×•× ××•× ×˜×¨×™×™',
                subTitle: 'Cannery Row',
                timeBase: '09:00',
                description: '××—×“ ×”××¤×•×¨×¡××™× ×‘×¢×•×œ×. ××•××œ×¥ ×œ×”×–××™×Ÿ ×›×¨×˜×™×¡×™× ××¨××© ×‘××ª×¨ ×©×œ×”×.',
                type: 'stop',
                icon: 'fish',
                coords: { lat: 36.6183, lng: -121.9015 },
                parking: { name: '×—× ×™×•×Ÿ Cannery Row', address: '601 Foam St', coords: { lat: 36.6145, lng: -121.8988 }, cost: '$20 ×œ×™×•×' },
                image: "https://media-cdn.tripadvisor.com/media/photo-s/12/e8/d0/6c/back-decks-and-great.jpg"
            },
            {
                id: 'carmel',
                title: '×›×¨××œ',
                subTitle: 'Carmel-by-the-Sea',
                timeBase: '11:30',
                description: '×™×•×¨×“×™× ×§×¦×ª ×“×¨×•××” ×œ×¡×™×‘×•×‘ ×’×œ×¨×™×•×ª ×•×—×•×£ ×™× ×œ×‘×Ÿ.',
                type: 'stop',
                icon: 'coffee',
                coords: { lat: 36.5552, lng: -121.9233 },
                parking: { name: '×—× ×™×•×Ÿ Vista Lobos', address: '3rd Ave & Torres St', coords: { lat: 36.5560, lng: -121.9215 }, cost: '×—×™× ×' },
                image: "https://dynamic-media-cdn.tripadvisor.com/media/photo-o/0a/66/e2/75/20160221-091502-1-largejpg.jpg?w=600&h=-1&s=1"
            },
            {
                id: 'bixby',
                title: '×’×©×¨ ×‘×™×§×¡×‘×™',
                subTitle: 'Big Sur Bridge',
                timeBase: '13:20',
                description: '×”×ª××•× ×” ×”××¤×•×¨×¡××ª ×‘×™×•×ª×¨ ×©×œ ×›×‘×™×© 1. ×–×”×™×¨×•×ª ×‘×—×¦×™×™×ª ×”×›×‘×™×©!',
                type: 'stop',
                icon: 'camera',
                coords: { lat: 36.3714, lng: -121.9017 },
                parking: { name: '××¤×¨×¥ ×—× ×™×” ×¦×¤×•× ×™', address: 'Hwy 1 (North)', coords: { lat: 36.3725, lng: -121.9030 }, cost: '×—×™× ×' },
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ2zJIDl1fe1ZGo7UfUrx2iHn1dYXzNNPtTfggtnUme6A&s=10"
            },
            {
                id: 'sf',
                title: '×¡×™×•×: ×¡×Ÿ ×¤×¨× ×¡×™×¡×§×•',
                subTitle: 'Fisherman\'s Wharf',
                timeBase: '17:00',
                description: '×”×’×¢×” ×œ×¢×™×¨ ×”×’×“×•×œ×”. ×”×—×–×¨×ª ×”×¨×›×‘ ×•×¡×™×•× ×”×˜×™×•×œ.',
                type: 'stop',
                icon: 'anchor',
                coords: { lat: 37.8080, lng: -122.4177 },
                parking: { name: '×—× ×™×•×Ÿ ×”××œ×•×Ÿ', coords: { lat: 37.8080, lng: -122.4177 }, cost: '×™×§×¨' },
                image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcThRZsv_ufgRrqGw4E1tFyxdTSwAQoAxAfQGk5jrZAlaTvcZzTjQ3fM_-J5&s=10"
            }
        ];

        // --- STATE & UTILS ---
        
        let isTracking = false;
        let watchId = null;
        let userLocation = null;
        let activeSegment = 0;
        let etas = {};

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function deg2rad(deg) { return deg * (Math.PI/180); }

        function estimateTravelTimeMinutes(lat1, lon1, lat2, lon2) {
            const dist = getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2);
            const adjustedDist = dist * 1.35; // ×¤×§×˜×•×¨ ×¤×™×ª×•×œ×™×
            const speedKmh = 70; 
            const hours = adjustedDist / speedKmh;
            return Math.round(hours * 60);
        }

        // --- RENDER FUNCTIONS ---

        function renderTimeline() {
            const container = document.getElementById('itinerary-container');
            container.innerHTML = ''; // Clear previous

            ITINERARY.forEach((stop, index) => {
                if (stop.type === 'divider') {
                    container.innerHTML += `
                        <div class="relative z-10 my-10 flex items-center justify-center">
                            <span class="bg-slate-800 text-white px-5 py-1.5 rounded-full text-sm font-bold shadow-lg">
                                ${stop.title}
                            </span>
                        </div>
                    `;
                    return;
                }

                const isActiveSeg = index === activeSegment;
                const isPast = index <= activeSegment;
                const eta = etas[stop.id];
                const hasEta = isTracking && userLocation && eta !== undefined && !isPast && eta > 0;
                
                // Show gas button logic
                const showGasBtn = index < ITINERARY.length - 1 && ITINERARY[index+1].type !== 'divider' && GAS_STATIONS_DATA[stop.id];

                // Image Logic
                let imageHTML = '';
                if (stop.isEmoji) {
                    imageHTML = `
                        <div class="w-full h-full bg-gradient-to-br ${stop.bgGradient} flex items-center justify-center">
                            <span class="text-6xl drop-shadow-md">${stop.emoji}</span>
                        </div>
                    `;
                } else {
                    imageHTML = `<img src="${stop.image}" alt="${stop.title}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105">`;
                }

                const cardHTML = `
                <div id="stop-${index}" class="relative mb-6">
                    
                    <!-- Car Icon Container (Will be injected dynamically) -->
                    <div id="car-container-${index}" class="absolute right-[13px] z-30 pointer-events-none" style="display:none; top:0; transform: translateY(24px);">
                        <div class="bg-blue-600 p-1.5 rounded-full border-[3px] border-white shadow-xl ring-2 ring-blue-300/50 car-bounce">
                            <i data-lucide="car" class="w-4 h-4 text-white"></i>
                        </div>
                    </div>

                    <div class="flex items-start gap-4">
                        <!-- Timeline Dot -->
                        <div class="relative shrink-0 w-8 h-8 rounded-full border-[3px] z-10 flex items-center justify-center bg-white shadow-sm transition-colors duration-500 mt-8 ${isPast ? 'border-blue-500' : 'border-gray-300'}">
                            <div class="w-2.5 h-2.5 rounded-full ${isPast ? 'bg-blue-500' : 'bg-gray-300'}"></div>
                        </div>

                        <!-- Card -->
                        <div onclick="openModal(${index})" class="relative grow bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden cursor-pointer active:scale-[0.98] transition-all duration-200 group ${isActiveSeg ? 'ring-2 ring-blue-400 ring-offset-4 ring-offset-slate-50' : ''}">
                            
                            <div class="h-32 w-full overflow-hidden relative bg-gray-100">
                                ${imageHTML}
                                <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                                <div class="absolute top-2 left-2 bg-white/95 backdrop-blur-sm p-1.5 rounded-full text-gray-800 shadow-sm">
                                    <i data-lucide="${stop.icon}" class="w-4 h-4"></i>
                                </div>
                                <div class="absolute bottom-3 right-3 text-white">
                                    <div class="text-lg font-black leading-none drop-shadow-md tracking-tight">${stop.title}</div>
                                    <div class="text-xs opacity-90 font-medium mt-1">${stop.subTitle}</div>
                                </div>
                            </div>

                            <div class="p-3.5">
                                <div class="flex justify-between items-center mb-2">
                                    <div class="flex items-center gap-1.5 bg-gray-100 px-2 py-1 rounded-md border border-gray-200">
                                        <i data-lucide="clock" class="w-3 h-3 text-gray-500"></i>
                                        <span class="text-xs font-bold text-gray-700 font-mono">${stop.timeBase}</span>
                                    </div>

                                    ${hasEta ? `
                                    <div class="flex items-center gap-1 text-green-700 text-[11px] font-bold bg-green-50 px-2 py-1 rounded-full border border-green-200 shadow-sm animate-pulse">
                                        <i data-lucide="car" class="w-3 h-3"></i>
                                        ×¢×•×“ ×›-${Math.floor(eta / 60)} ×©×³ ×•-${eta % 60} ×“×§×³
                                    </div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gas Button -->
                    ${showGasBtn ? `
                    <div class="ml-4 mr-[30px] my-3 relative z-0">
                        <div class="absolute right-[21px] -top-4 -bottom-4 w-[2px] border-l-2 border-dashed border-gray-300"></div>
                        <button onclick="openGasModal('${stop.id}')" class="relative w-full bg-white border border-orange-200 rounded-xl p-2 flex items-center gap-3 shadow-sm active:scale-95 transition hover:bg-orange-50 group">
                            <div class="bg-orange-100 text-orange-600 p-1.5 rounded-lg">
                                <i data-lucide="fuel" class="w-4 h-4"></i>
                            </div>
                            <div class="text-right">
                                <div class="text-xs font-bold text-gray-700">×“×œ×§ ×–×•×œ ×‘×“×¨×š?</div>
                                <div class="text-[10px] text-gray-400">×œ×—×¥ ×œ-3 ×ª×—× ×•×ª ××•××œ×¦×•×ª</div>
                            </div>
                            <div class="mr-auto bg-orange-500 text-white rounded-full p-1">
                                <i data-lucide="map" class="w-3 h-3"></i>
                            </div>
                        </button>
                    </div>` : ''}

                </div>`;

                container.innerHTML += cardHTML;
            });

            // Re-initialize icons
            lucide.createIcons();
        }

        // --- TRACKING LOGIC ---

        function toggleTracking() {
            if (!isTracking) {
                // Start
                if (navigator.geolocation) {
                    document.getElementById('trackBtnText').innerText = "×××ª×¨...";
                    document.getElementById('gpsStatus').classList.remove('hidden');
                    
                    watchId = navigator.geolocation.watchPosition(
                        (position) => {
                            isTracking = true;
                            userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                            
                            // UI Updates
                            document.getElementById('trackBtnText').innerText = "××™×¤×” ×× ×™?";
                            document.getElementById('trackBtn').classList.remove('bg-green-600', 'active:bg-green-700');
                            document.getElementById('trackBtn').classList.add('bg-blue-100', 'text-blue-700', 'border-blue-200');
                            document.getElementById('trackBtn').onclick = scrollToCurrent;
                            document.getElementById('gpsStatus').classList.add('hidden');
                            
                            updateTripStatus();
                        },
                        (error) => {
                            alert("×œ× × ×™×ª×Ÿ ×œ×’×©×ª ×œ××™×§×•×. ×•×•×“× ×©×”-GPS ×“×œ×•×§.");
                            document.getElementById('trackBtnText').innerText = "×”×¤×¢×œ ×–××Ÿ ×××ª";
                        },
                        { enableHighAccuracy: true, maximumAge: 5000, timeout: 5000 }
                    );
                } else {
                    alert("×”××›×©×™×¨ ×œ× ×ª×•××š ×‘-GPS");
                }
            }
        }

        function updateTripStatus() {
            if (!userLocation) return;
            const { lat, lng } = userLocation;

            // 1. Calculate ETAs
            let newEtas = {};
            ITINERARY.forEach((stop) => {
                if (stop.coords) {
                    const minutes = estimateTravelTimeMinutes(lat, lng, stop.coords.lat, stop.coords.lng);
                    newEtas[stop.id] = minutes < 5 ? 0 : minutes;
                }
            });
            etas = newEtas;

            // 2. Find Active Segment & Progress
            let foundSegment = 0;
            let progress = 0;
            const stops = ITINERARY.filter(s => s.type !== 'divider');
            
            for (let i = 0; i < stops.length - 1; i++) {
                const currentStop = stops[i];
                const nextStop = stops[i+1];
                
                // Simple latitude logic (going North)
                if (lat > currentStop.coords.lat) {
                    foundSegment = ITINERARY.findIndex(s => s.id === currentStop.id);
                    const totalLatDiff = nextStop.coords.lat - currentStop.coords.lat;
                    const myLatDiff = lat - currentStop.coords.lat;
                    progress = myLatDiff / totalLatDiff;
                    progress = Math.max(0, Math.min(1, progress));
                }
            }

            activeSegment = foundSegment;

            // 3. Render updates (re-render timeline to show new times and styles)
            renderTimeline();

            // 4. Update Car Position
            // Hide all cars first
            document.querySelectorAll('[id^="car-container-"]').forEach(el => el.style.display = 'none');
            
            // Show active car and position it
            const activeCar = document.getElementById(`car-container-${activeSegment}`);
            if (activeCar) {
                activeCar.style.display = 'block';
                activeCar.style.top = `${progress * 100}%`;
            }
        }

        function scrollToCurrent() {
            const el = document.getElementById(`stop-${activeSegment}`);
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // --- NAVIGATION ---

        function navigate(lat, lng, type) {
            let url = '';
            if (type === 'waze') {
                url = `https://www.waze.com/ul?ll=${lat},${lng}&navigate=yes`;
            } else {
                url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
            }
            window.open(url, '_blank');
        }

        function navigateAddress(query, type) {
            let url = '';
            if (type === 'waze') {
                url = `https://www.waze.com/ul?q=${encodeURIComponent(query)}&navigate=yes`;
            } else {
                url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
            }
            window.open(url, '_blank');
        }

        // --- MODALS ---

        function openModal(index) {
            const stop = ITINERARY[index];
            const modal = document.getElementById('mainModal');
            const content = document.getElementById('modalContent');
            
            document.body.style.overflow = 'hidden';

            let imageHTML = '';
             if (stop.isEmoji) {
                imageHTML = `
                    <div class="w-full h-full bg-gradient-to-br ${stop.bgGradient} flex items-center justify-center">
                        <span class="text-8xl drop-shadow-lg">${stop.emoji}</span>
                    </div>`;
            } else {
                imageHTML = `<img src="${stop.image}" class="w-full h-full object-cover">`;
            }

            content.innerHTML = `
                <div class="w-full flex justify-center pt-3 pb-1" onclick="closeModal()">
                    <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
                </div>
                
                <div class="h-48 relative shrink-0 mt-2 mx-2 rounded-2xl overflow-hidden">
                    ${imageHTML}
                    <button onclick="closeModal()" class="absolute top-3 left-3 bg-black/30 text-white p-2 rounded-full backdrop-blur-md"><i data-lucide="x" class="w-5 h-5"></i></button>
                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent p-5 pt-10">
                        <h2 class="text-white text-2xl font-black">${stop.title}</h2>
                        <p class="text-white/90 text-sm font-medium">${stop.subTitle}</p>
                    </div>
                </div>

                <div class="p-5 overflow-y-auto flex-1">
                    <p class="text-gray-600 leading-relaxed text-sm mb-6 bg-gray-50 p-3 rounded-xl border border-gray-100">${stop.description}</p>
                    
                    ${stop.parking ? `
                    <div class="mb-6">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">×¤×¨×˜×™ ×—× ×™×”</h3>
                        <div class="bg-white border border-gray-200 p-4 rounded-xl flex gap-3 shadow-sm">
                            <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center shrink-0 font-bold text-lg">P</div>
                            <div>
                                <div class="font-bold text-gray-800 text-sm">${stop.parking.name}</div>
                                <div class="text-gray-500 text-xs mt-0.5">${stop.parking.address}</div>
                                <div class="mt-1.5 inline-block bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded font-bold">${stop.parking.cost}</div>
                            </div>
                        </div>
                    </div>` : ''}

                    <div class="grid grid-cols-2 gap-3 pb-6 mt-auto">
                        <button onclick="navigate(${stop.coords.lat}, ${stop.coords.lng}, 'waze')" class="bg-blue-600 text-white py-3.5 rounded-2xl text-sm font-bold shadow-lg shadow-blue-200 flex justify-center items-center gap-2 active:scale-95 transition">
                            <i data-lucide="navigation" class="w-4 h-4"></i> ×¡×¢ ×œ×™×¢×“
                        </button>
                        <button onclick="navigate(${stop.parking ? stop.parking.coords.lat : stop.coords.lat}, ${stop.parking ? stop.parking.coords.lng : stop.coords.lng}, 'google')" class="bg-gray-100 text-gray-800 py-3.5 rounded-2xl text-sm font-bold border border-gray-200 flex justify-center items-center gap-2 active:scale-95 transition">
                            <i data-lucide="map" class="w-4 h-4"></i> ×’×•×’×œ ××¤×¡
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        function closeModal() {
            document.getElementById('mainModal').classList.add('hidden');
            document.body.style.overflow = 'unset';
        }

        function openGasModal(segmentId) {
            const modal = document.getElementById('gasModal');
            const content = document.getElementById('gasModalContent');
            const stations = GAS_STATIONS_DATA[segmentId];
            
            document.body.style.overflow = 'hidden';
            content.innerHTML = '';

            if (stations) {
                stations.forEach(station => {
                    content.innerHTML += `
                        <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col gap-2">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-black text-gray-800 text-lg">${station.name}</h3>
                                    <p class="text-xs text-gray-500">${station.address}</p>
                                </div>
                                <div class="text-lg font-black px-2 py-1 rounded ${station.price.includes("$7") ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-700'}">
                                    ${station.price}
                                </div>
                            </div>
                            ${station.note ? `<div class="text-[11px] text-orange-600 bg-orange-50 px-2 py-1 rounded border border-orange-100 inline-block self-start">ğŸ’¡ ${station.note}</div>` : ''}
                            ${station.price !== '---' ? `
                            <button onclick="navigateAddress('${station.address}', 'waze')" class="mt-2 w-full bg-slate-800 text-white py-2 rounded-lg text-xs font-bold flex justify-center items-center gap-2 active:scale-95 transition">
                                <i data-lucide="navigation" class="w-3 h-3"></i> × ×•×•×˜ ×œ×ª×—× ×” (Waze)
                            </button>` : ''}
                        </div>
                    `;
                });
            } else {
                content.innerHTML = '<p class="text-center text-gray-400">××™×Ÿ ××™×“×¢ ××™×•×—×“ ×¢×œ ×“×œ×§ ×‘××§×˜×¢ ×–×”.</p>';
            }

            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        function closeGasModal() {
            document.getElementById('gasModal').classList.add('hidden');
            document.body.style.overflow = 'unset';
        }

        // Initialize
        renderTimeline();

    </script>
</body>
</html>

