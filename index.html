import React, { useState, useEffect, useRef } from 'react';
import { MapPin, Navigation, Car, X, Compass, Anchor, Coffee, Bed, Fuel, Camera, Fish, Clock, Zap, Map } from 'lucide-react';

// === × ×ª×•× ×™ ×ª×—× ×•×ª ×“×œ×§ ×œ×¤×™ ××§×˜×¢×™× ===
// ×”××¤×ª×— ×”×•× ×”-ID ×©×œ ×”×ª×—× ×” ×©××× ×” ×™×•×¦××™×
const GAS_STATIONS_DATA = {
  'start': [ // ××œ×•×¡ ×× ×’'×œ×¡ ×œ×¡× ×˜×” ×‘×¨×‘×¨×”
    { name: "ARCO", address: "1935 N Oxnard Blvd, Oxnard", price: "$4.39", note: "×–×•×œ ×××•×“, ××§×‘×œ×™× ×¨×§ Debit ××• ××–×•××Ÿ" },
    { name: "United Oil", address: "2888 E Thousand Oaks Blvd", price: "$4.45", note: "×ª×—× ×” ×’×“×•×œ×” ×¢×œ ×”×“×¨×š" },
    { name: "Valero", address: "500 S Ventura Rd, Oxnard", price: "$4.49", note: "××—×™×¨ ×”×•×’×Ÿ" }
  ],
  'sb': [ // ××¡× ×˜×” ×‘×¨×‘×¨×” ×œ×¡×•×œ×‘× ×’
    { name: "Fuel Depot", address: "5767 Calle Real, Goleta", price: "$4.55", note: "×”×›×™ ×–×•×œ ×‘×™×¦×™××” ××¡× ×˜×” ×‘×¨×‘×¨×”" },
    { name: "ARCO", address: "175 E Hwy 246, Buellton", price: "$4.35", note: "×××© ×‘×›× ×™×¡×” ×œ×¡×•×œ×‘× ×’" },
    { name: "Conserv Fuel", address: "150 S La Cumbre Rd", price: "$4.59", note: "" }
  ],
  'solvang': [ // ××¡×•×œ×‘× ×’ ×œ×¡×Ÿ ×œ×•××™×¡ ××•×‘×™×¡×¤×•
    { name: "ARCO", address: "898 Oak Park Blvd, Pismo Beach", price: "$4.29", note: "×ª×“×œ×•×§ ××¢×•×œ×” ×œ×¤× ×™ SLO" },
    { name: "Speedway Express", address: "1350 Grand Ave, Arroyo Grande", price: "$4.35", note: "" },
    { name: "Chevron", address: "460 W Tefft St, Nipomo", price: "$4.65", note: "××™×›×•×ª×™ ××š ×™×§×¨ ×™×•×ª×¨" }
  ],
  'gas': [ // ×-SLO ×œ××•×¨×• ×‘×™×™ (× ×¡×™×¢×” ×§×¦×¨×”)
    { name: "Morro Bay Fuel", address: "1590 Main St, Morro Bay", price: "$4.45", note: "×‘×ª×•×š ×”×¢×™×¨" },
    { name: "Sinclair", address: "940 Morro Bay Blvd", price: "$4.49", note: "×“×™× ×•×–××•×¨ ×™×¨×•×§, ××—×™×¨ ×¡×‘×‘×”" },
    { name: "Mobil", address: "911 Morro Bay Blvd", price: "$4.69", note: "" }
  ],
  'morro': [ // ×××•×¨×• ×‘×™×™ ×œ×¤×™×œ×™ ×”×™× (×¡×Ÿ ×¡×™××™×•×Ÿ)
    { name: "Chevron Cambria", address: "2194 Main St, Cambria", price: "$5.89", note: "×™×§×¨! ×œ×ª×“×œ×§ ×¨×§ ×× ×—×™×™×‘×™×" },
    { name: "San Simeon Market", address: "9290 Hearst Dr", price: "$6.10", note: "××œ×›×•×“×ª ×ª×™×™×¨×™×, ×œ×”×™×× ×¢" },
    { name: "××–×”×¨×”", address: "×ª×“×œ×§×• ×‘××•×¨×• ×‘×™×™!", price: "---", note: "××™×Ÿ ×ª×—× ×•×ª ×–×•×œ×•×ª ×‘×§×˜×¢ ×”×–×”" }
  ],
  'seals': [ // ××¤×™×œ×™ ×”×™× ×œ××•× ×˜×¨×™×™ (×‘×™×’ ×¡×¨ - ×§×˜×¢ ××¨×•×š ×œ×œ× ×“×œ×§)
    { name: "Ragged Point", address: "19019 CA-1", price: "$7.99", note: "×—×™×¨×•× ×‘×œ×‘×“! ×”×™×§×¨ ×‘×§×œ×™×¤×•×¨× ×™×”" },
    { name: "Big Sur Station", address: "47540 CA-1", price: "$8.20", note: "×—×™×¨×•× ×‘×œ×‘×“" },
    { name: "Gorda Gas", address: "HC 67, Big Sur", price: "$7.50", note: "×—×™×¨×•× ×‘×œ×‘×“" }
  ],
  'monterey': [ // ×‘××™×–×•×¨ ××•× ×˜×¨×™×™ (×œ××—×¨×ª)
    { name: "Safeway Fuel", address: "104 Canyon Del Rey, Del Rey Oaks", price: "$4.25", note: "×œ×¨×•×‘ ×”×›×™ ×–×•×œ ×‘××™×–×•×¨" },
    { name: "Valero", address: "2200 N Fremont St, Monterey", price: "$4.39", note: "××—×™×¨ ×˜×•×‘" },
    { name: "76", address: "2106 N Fremont St", price: "$4.49", note: "" }
  ],
  // ×©××¨ ×”××§×˜×¢×™× ×¤×—×•×ª ×§×¨×™×˜×™×™× ××• ×¢×™×¨×•× ×™×™×
};

const ITINERARY = [
  {
    id: 'start',
    title: '×™×¦×™××”: ×œ×•×¡ ×× ×’\'×œ×¡',
    timeBase: '09:00',
    description: '×™×¦×™××” ×××œ×•×Ÿ Westin Bonaventure. ×•×•×“××• ×©×™×© ××™×, ×›×‘×œ×™× ×œ×˜×œ×¤×•×Ÿ ×•× ×©× ×•×©×™× ×œ×“×¨×š!',
    type: 'start',
    icon: Car,
    coords: { lat: 34.0528, lng: -118.2556 },
    parking: { name: '×œ×•×‘×™ ×”××œ×•×Ÿ (×™×¦×™××”)', coords: { lat: 34.0528, lng: -118.2556 }, cost: '---' },
    image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ3p6yTIcIs92AnFZfplUcSVPCaXzjjpc_hdRUxa4vbcA&s=10"
  },
  {
    id: 'sb',
    title: '×¡× ×˜×” ×‘×¨×‘×¨×”',
    subTitle: 'Stearns Wharf',
    timeBase: '11:00',
    description: '×¢×¦×™×¨×” ×§×œ××¡×™×ª. ××•××œ×¥ ×œ×—× ×•×ª ×•×œ×œ×›×ª ×œ××–×— ×”×¢×¥ ×”×¢×ª×™×§. ××•×•×™×¨×” ×©×œ ×¨×™×‘×™×™×¨×”.',
    type: 'stop',
    icon: Anchor,
    coords: { lat: 34.4123, lng: -119.6876 }, 
    parking: { name: '×—× ×™×•×Ÿ ×”××–×— (City Lot #1)', address: '23 E Cabrillo Blvd', coords: { lat: 34.4137, lng: -119.6905 }, cost: '×—×™× × ×œ-75 ×“×§×³' },
    image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSB1m_VYizll6MT567ggSruv9ImG91t4HKdwqXT1wxLWA&s=10"
  },
  {
    id: 'solvang',
    title: '×¡×•×œ×‘× ×’',
    subTitle: '×”×¢×™×™×¨×” ×”×“× ×™×ª',
    timeBase: '12:30',
    description: '×”×¤×¡×§×ª ×¦×”×¨×™×™×. ×œ×”×¨×’×™×© ×‘××™×¨×•×¤×” ×‘×××¦×¢ ×§×œ×™×¤×•×¨× ×™×”. ×—×•×‘×” ×œ×˜×¢×•× ×××¤×” ×“× ×™.',
    type: 'stop',
    icon: Coffee,
    coords: { lat: 34.5958, lng: -120.1376 },
    parking: { name: 'Solvang Public Parking', address: '1616 Oak St', coords: { lat: 34.5945, lng: -120.1408 }, cost: '×—×™× ×' },
    image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS2NgP8pvIZShu5F_1XhFvbqpMI-fDt3sSXwxNpXw4IHg&s=10"
  },
  {
    id: 'gas',
    title: '×ª×“×œ×•×§ ×—×•×‘×”!',
    subTitle: '×¡×Ÿ ×œ×•××™×¡ ××•×‘×™×¡×¤×•',
    timeBase: '14:30',
    description: '× ×§×•×“×” ×§×¨×™×˜×™×ª. ××›××Ÿ ×•×”×œ××” ××™×Ÿ ×ª×—× ×•×ª ×“×œ×§ × ×•×¨××œ×™×•×ª ×œ××©×š ×©×¢×•×ª. ××œ××• ××™×›×œ ××œ×!',
    type: 'gas',
    icon: Fuel,
    coords: { lat: 35.2675, lng: -120.6481 },
    parking: { name: '×ª×—× ×ª Conserv Fuel', address: '2211 Broad St', coords: { lat: 35.2675, lng: -120.6481 }, cost: '××—×™×¨ ×”×•×’×Ÿ' },
    isEmoji: true, emoji: "â›½", bgGradient: "from-orange-400 to-red-500"
  },
  {
    id: 'morro',
    title: '××•×¨×• ×‘×™×™',
    subTitle: 'Morro Rock',
    timeBase: '15:00',
    description: '×¢×¦×™×¨×” ×§×¦×¨×” ×œ×ª××•× ×” ×¢× ×”×¡×œ×¢ ×”×’×¢×©×™ ×”×¢×¦×•× ×©×‘×•×§×¢ ××”×™×.',
    type: 'stop',
    icon: Camera,
    coords: { lat: 35.3712, lng: -120.8667 },
    parking: { name: '×—× ×™×•×Ÿ ×”×—×•×£ (Coleman Park)', address: 'Coleman Dr', coords: { lat: 35.3705, lng: -120.8650 }, cost: '×—×™× ×' },
    image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQNR-4naNKMPmIiq99YbgSSK0VvTVhUrTG-W_7YMbSYOg&s=10"
  },
  {
    id: 'seals',
    title: '×¤×™×œ×™ ×”×™×',
    subTitle: 'San Simeon',
    timeBase: '16:15',
    description: '×”×©×™× ×©×œ ×”× ×¡×™×¢×”! ××œ×¤×™ ×¤×™×œ×™ ×™× ×¨×•×‘×¦×™× ×¢×œ ×”×—×•×£. ×¨×¢×© ×•×¨×™×— ×©×œ× ×©×•×›×—×™×.',
    type: 'stop',
    icon: Fish,
    coords: { lat: 35.6630, lng: -121.2575 },
    parking: { name: '×—× ×™×•×Ÿ ×”×ª×¦×¤×™×ª', address: 'Hwy 1 Vista Point', coords: { lat: 35.6630, lng: -121.2575 }, cost: '×—×™× ×' },
    isEmoji: true, emoji: "ğŸ¦­", bgGradient: "from-blue-400 to-cyan-600"
  },
  {
    id: 'monterey',
    title: '×”×’×¢×” ×œ××œ×•×Ÿ',
    subTitle: 'Victorian Inn',
    timeBase: '18:30',
    description: '×¡×™×•× ×”×™×•× ×”×¨××©×•×Ÿ. ×”××œ×•×Ÿ × ××¦× ×‘××¨×—×§ ×”×œ×™×›×” ×-Cannery Row.',
    type: 'hotel',
    icon: Bed,
    coords: { lat: 36.6128, lng: -121.9001 },
    parking: { name: '×—× ×™×•×Ÿ ×”××œ×•×Ÿ', address: '487 Foam St', coords: { lat: 36.6128, lng: -121.9001 }, cost: '×œ××•×¨×—×™ ×”××œ×•×Ÿ' },
    isEmoji: true, emoji: "ğŸ¨", bgGradient: "from-indigo-500 to-purple-600"
  },
  { id: 'day2', title: '×™×•× ×©× ×™ (02/02)', type: 'divider' },
  {
    id: 'aquarium',
    title: '××§×•×•×¨×™×•× ××•× ×˜×¨×™×™',
    subTitle: 'Cannery Row',
    timeBase: '09:00',
    description: '××—×“ ×”××¤×•×¨×¡××™× ×‘×¢×•×œ×. ××•××œ×¥ ×œ×”×–××™×Ÿ ×›×¨×˜×™×¡×™× ××¨××© ×‘××ª×¨ ×©×œ×”×.',
    type: 'stop',
    icon: Fish,
    coords: { lat: 36.6183, lng: -121.9015 },
    parking: { name: '×—× ×™×•×Ÿ Cannery Row', address: '601 Foam St', coords: { lat: 36.6145, lng: -121.8988 }, cost: '$20 ×œ×™×•×' },
    image: "https://media-cdn.tripadvisor.com/media/photo-s/12/e8/d0/6c/back-decks-and-great.jpg"
  },
  {
    id: 'carmel',
    title: '×›×¨××œ',
    subTitle: 'Carmel-by-the-Sea',
    timeBase: '11:30',
    description: '×™×•×¨×“×™× ×§×¦×ª ×“×¨×•××” ×œ×¡×™×‘×•×‘ ×’×œ×¨×™×•×ª ×•×—×•×£ ×™× ×œ×‘×Ÿ.',
    type: 'stop',
    icon: Coffee,
    coords: { lat: 36.5552, lng: -121.9233 },
    parking: { name: '×—× ×™×•×Ÿ Vista Lobos', address: '3rd Ave & Torres St', coords: { lat: 36.5560, lng: -121.9215 }, cost: '×—×™× ×' },
    image: "https://dynamic-media-cdn.tripadvisor.com/media/photo-o/0a/66/e2/75/20160221-091502-1-largejpg.jpg?w=600&h=-1&s=1"
  },
  {
    id: 'bixby',
    title: '×’×©×¨ ×‘×™×§×¡×‘×™',
    subTitle: 'Big Sur Bridge',
    timeBase: '13:20',
    description: '×”×ª××•× ×” ×”××¤×•×¨×¡××ª ×‘×™×•×ª×¨ ×©×œ ×›×‘×™×© 1. ×–×”×™×¨×•×ª ×‘×—×¦×™×™×ª ×”×›×‘×™×©!',
    type: 'stop',
    icon: Camera,
    coords: { lat: 36.3714, lng: -121.9017 },
    parking: { name: '××¤×¨×¥ ×—× ×™×” ×¦×¤×•× ×™', address: 'Hwy 1 (North)', coords: { lat: 36.3725, lng: -121.9030 }, cost: '×—×™× ×' },
    image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ2zJIDl1fe1ZGo7UfUrx2iHn1dYXzNNPtTfggtnUme6A&s=10"
  },
  {
    id: 'sf',
    title: '×¡×™×•×: ×¡×Ÿ ×¤×¨× ×¡×™×¡×§×•',
    subTitle: 'Fisherman\'s Wharf',
    timeBase: '17:00',
    description: '×”×’×¢×” ×œ×¢×™×¨ ×”×’×“×•×œ×”. ×”×—×–×¨×ª ×”×¨×›×‘ ×•×¡×™×•× ×”×˜×™×•×œ.',
    type: 'stop',
    icon: Anchor,
    coords: { lat: 37.8080, lng: -122.4177 },
    parking: { name: '×—× ×™×•×Ÿ ×”××œ×•×Ÿ', coords: { lat: 37.8080, lng: -122.4177 }, cost: '×™×§×¨' },
    image: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcThRZsv_ufgRrqGw4E1tFyxdTSwAQoAxAfQGk5jrZAlaTvcZzTjQ3fM_-J5&s=10"
  }
];

// === ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×’×™××•×’×¨×¤×™×•×ª ===

function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
  const R = 6371; 
  const dLat = deg2rad(lat2 - lat1);
  const dLon = deg2rad(lon2 - lon1);
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function deg2rad(deg) { return deg * (Math.PI/180); }

function estimateTravelTimeMinutes(lat1, lon1, lat2, lon2) {
    const dist = getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2);
    const adjustedDist = dist * 1.35; 
    const speedKmh = 70; 
    const hours = adjustedDist / speedKmh;
    return Math.round(hours * 60);
}

// === ×”×§×•××¤×•× × ×˜×” ×”×¨××©×™×ª ===

export default function RoadTripAppUltimate() {
  const [selectedStop, setSelectedStop] = useState(null);
  const [gasModalSegment, setGasModalSegment] = useState(null); // ×”××§×˜×¢ ×©× ×‘×—×¨ ×œ×”×¦×’×ª ×“×œ×§
  const [isTracking, setIsTracking] = useState(false);
  const [userLocation, setUserLocation] = useState(null);
  const [activeSegment, setActiveSegment] = useState(0); 
  const [segmentProgress, setSegmentProgress] = useState(0); 
  const [etas, setEtas] = useState({}); 

  const scrollRefs = useRef([]);
  const watchIdRef = useRef(null);

  // ×—×¡×™××ª ×’×œ×™×œ×” ×›×©××•×“×œ ×¤×ª×•×—
  useEffect(() => {
    if (selectedStop || gasModalSegment) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'unset';
    }
  }, [selectedStop, gasModalSegment]);

  // ×”×ª×—×œ×ª ××¢×§×‘ ××™×§×•× (×¨×§ ×‘×œ×—×™×¦×” ×¢×œ ×”×›×¤×ª×•×¨)
  const startTracking = () => {
    setIsTracking(true);
    if (navigator.geolocation) {
      watchIdRef.current = navigator.geolocation.watchPosition(
        (position) => {
          const { latitude, longitude } = position.coords;
          // ×œ×–×™×™×£ ××™×§×•× ×œ×‘×“×™×§×” (×œ×™×“ ×¡× ×˜×” ×‘×¨×‘×¨×”):
          // const latitude = 34.3; const longitude = -119.5; 
          
          setUserLocation({ lat: latitude, lng: longitude });
          updateTripStatus(latitude, longitude);
        },
        (error) => {
            console.error("Location error:", error);
            alert("×œ× × ×™×ª×Ÿ ×œ×§×‘×œ ××™×§×•×. ×•×•×“× ×©×”-GPS ×“×œ×•×§ ×•××™×©×¨×ª ×’×™×©×”.");
            setIsTracking(false);
        },
        { enableHighAccuracy: true, maximumAge: 5000, timeout: 5000 }
      );
    } else {
        alert("×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘-GPS");
    }
  };

  const stopTracking = () => {
      if (watchIdRef.current) navigator.geolocation.clearWatch(watchIdRef.current);
      setIsTracking(false);
      setUserLocation(null);
  };

  const updateTripStatus = (lat, lng) => {
    const newEtas = {};
    ITINERARY.forEach((stop) => {
        if (stop.coords) {
            const minutes = estimateTravelTimeMinutes(lat, lng, stop.coords.lat, stop.coords.lng);
            newEtas[stop.id] = minutes < 5 ? 0 : minutes;
        }
    });
    setEtas(newEtas);

    let foundSegment = 0;
    const stops = ITINERARY.filter(s => s.type !== 'divider');
    for (let i = 0; i < stops.length - 1; i++) {
        const currentStop = stops[i];
        const nextStop = stops[i+1];
        if (lat > currentStop.coords.lat) {
            foundSegment = ITINERARY.findIndex(s => s.id === currentStop.id);
            const totalLatDiff = nextStop.coords.lat - currentStop.coords.lat;
            const myLatDiff = lat - currentStop.coords.lat;
            let progress = myLatDiff / totalLatDiff;
            progress = Math.max(0, Math.min(1, progress));
            setSegmentProgress(progress);
        }
    }
    setActiveSegment(foundSegment);
  };

  const scrollToCurrent = () => {
    if (activeSegment !== null && scrollRefs.current[activeSegment]) {
      scrollRefs.current[activeSegment].scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  };

  const openNavigation = (coordsOrQuery, app) => {
      let url = '';
      // ×ª××™×›×” ×‘×§×•××•×¨×“×™× ×˜×•×ª ××• ×‘×—×™×¤×•×© ×˜×§×¡×˜
      if (typeof coordsOrQuery === 'string') {
          // × ×™×•×•×˜ ×œ×›×ª×•×‘×ª ×˜×§×¡×˜ (×œ×ª×—× ×•×ª ×“×œ×§)
           url = app === 'waze' 
            ? `https://www.waze.com/ul?q=${encodeURIComponent(coordsOrQuery)}&navigate=yes`
            : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(coordsOrQuery)}`;
      } else if (coordsOrQuery && coordsOrQuery.lat) {
          // × ×™×•×•×˜ ×œ×§×•××•×¨×“×™× ×˜×•×ª
          url = app === 'waze' 
            ? `https://www.waze.com/ul?ll=${coordsOrQuery.lat},${coordsOrQuery.lng}&navigate=yes`
            : `https://www.google.com/maps/dir/?api=1&destination=${coordsOrQuery.lat},${coordsOrQuery.lng}`;
      }
      if(url) window.open(url, '_blank');
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans pb-24 max-w-md mx-auto relative shadow-2xl overflow-hidden text-gray-800" dir="rtl">
      
      {/* Header */}
      <div className="bg-white/90 backdrop-blur-md border-b border-gray-200 p-4 sticky top-0 z-20 shadow-sm transition-all flex flex-col gap-3">
        <div className="flex justify-between items-center">
            <div>
               <h1 className="text-xl font-black tracking-tight text-blue-700 flex items-center gap-2">
                   <Compass size={20} className="text-blue-500"/>
                   ××¡×¢ ×›×‘×™×© 1
                </h1>
               <p className="text-xs text-gray-500 font-medium">×œ×•×¡ ×× ×’'×œ×¡ â¬…ï¸ ×¡×Ÿ ×¤×¨× ×¡×™×¡×§×•</p>
            </div>
            
            {!isTracking ? (
                <button 
                    onClick={startTracking}
                    className="bg-green-600 active:bg-green-700 text-white px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2 shadow-lg shadow-green-200 animate-pulse"
                >
                    <Navigation size={14} />
                    ×”×¤×¢×œ ×–××Ÿ ×××ª
                </button>
            ) : (
                <button 
                    onClick={scrollToCurrent}
                    className="bg-blue-100 text-blue-700 px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2 border border-blue-200"
                >
                    <Car size={14} />
                    ××™×¤×” ×× ×™?
                </button>
            )}
        </div>
        
        {isTracking && !userLocation && (
            <div className="text-[10px] text-orange-600 bg-orange-50 px-2 py-1 rounded text-center font-bold">
                ×××ª×™×Ÿ ×œ×§×œ×™×˜×ª GPS...
            </div>
        )}
      </div>

      {/* Main Content Area */}
      <div className="px-5 relative pt-4">
        
        {/* ×§×• ×”××¡×œ×•×œ */}
        <div className="absolute top-0 bottom-0 right-[29px] w-[3px] bg-slate-200 z-0 rounded-full"></div>

        {ITINERARY.map((stop, index) => {
          if (stop.type === 'divider') {
              return (
                <div key={index} className="relative z-10 my-10 flex items-center justify-center">
                   <span className="bg-slate-800 text-white px-5 py-1.5 rounded-full text-sm font-bold shadow-lg">
                       {stop.title}
                   </span>
                </div>
              );
          }

          const isPast = index <= activeSegment;
          const isActiveSeg = index === activeSegment;
          const etaMinutes = etas[stop.id];
          // ××¦×™×’ ×–××Ÿ ×¨×§ ×× ××•×¤×¢×œ ××¢×§×‘, ×™×© ××™×§×•×, ×•×–×” ×œ× ×¢×‘×¨
          const hasEta = isTracking && userLocation && etaMinutes !== undefined && !isPast;
          
          // ×‘×“×™×§×” ×× ×œ×”×¦×™×’ ×›×¤×ª×•×¨ ×“×œ×§ (×¨×§ ×× ×–×” ×œ× ×”××—×¨×•×Ÿ ×•×™×© × ×ª×•× ×™× ×œ××§×˜×¢ ×”×–×”)
          const showGasBtn = index < ITINERARY.length - 1 && ITINERARY[index+1].type !== 'divider' && GAS_STATIONS_DATA[stop.id];

          return (
            <div 
                key={stop.id} 
                ref={el => scrollRefs.current[index] = el}
                className="relative mb-6"
            >
              {/* ×”××›×•× ×™×ª ×”×–×–×” */}
              {isActiveSeg && userLocation && (
                  <div 
                    className="absolute right-[13px] z-30 transition-all duration-1000 ease-linear pointer-events-none"
                    style={{ 
                        top: `${segmentProgress * 100}%`,
                        transform: 'translateY(24px)'
                    }}
                  >
                      <div className="bg-blue-600 p-1.5 rounded-full border-[3px] border-white shadow-xl ring-2 ring-blue-300/50">
                          <Car size={16} className="text-white fill-current" />
                      </div>
                  </div>
              )}

              <div className="flex items-start gap-4">
                {/* × ×§×•×“×” ×‘×¦×™×¨ ×”×–××Ÿ */}
                <div className={`
                    relative shrink-0 w-8 h-8 rounded-full border-[3px] z-10 flex items-center justify-center bg-white shadow-sm transition-colors duration-500 mt-8
                    ${isPast ? 'border-blue-500' : 'border-gray-300'}
                `}>
                    <div className={`w-2.5 h-2.5 rounded-full transition-colors duration-500 ${isPast ? 'bg-blue-500' : 'bg-gray-300'}`}></div>
                </div>

                {/* ×”×›×¨×˜×™×¡×™×™×” */}
                <div 
                    onClick={() => setSelectedStop(stop)}
                    className={`
                        relative grow bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden cursor-pointer
                        active:scale-[0.98] transition-all duration-200
                        ${isActiveSeg ? 'ring-2 ring-blue-400 ring-offset-4 ring-offset-slate-50' : ''}
                    `}
                >
                    {/* ×ª××•× ×” */}
                    <div className="h-32 w-full overflow-hidden relative bg-gray-100">
                         {stop.isEmoji ? (
                             <div className={`w-full h-full bg-gradient-to-br ${stop.bgGradient} flex items-center justify-center`}>
                                 <span className="text-6xl drop-shadow-md">{stop.emoji}</span>
                             </div>
                         ) : (
                             <img src={stop.image} alt={stop.title} className="w-full h-full object-cover" />
                         )}
                         
                         <div className="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                         
                         <div className="absolute top-2 left-2 bg-white/95 backdrop-blur-sm p-1.5 rounded-full text-gray-800 shadow-sm">
                             <stop.icon size={16} />
                         </div>

                         <div className="absolute bottom-3 right-3 text-white">
                             <div className="text-lg font-black leading-none drop-shadow-md tracking-tight">{stop.title}</div>
                             <div className="text-xs opacity-90 font-medium mt-1">{stop.subTitle}</div>
                         </div>
                    </div>

                    <div className="p-3.5">
                        <div className="flex justify-between items-center mb-2">
                             <div className="flex items-center gap-1.5 bg-gray-100 px-2 py-1 rounded-md border border-gray-200">
                                <Clock size={13} className="text-gray-500"/>
                                <span className="text-xs font-bold text-gray-700 font-mono">{stop.timeBase}</span>
                             </div>

                             {hasEta && (
                                 <div className="flex items-center gap-1 text-green-700 text-[11px] font-bold bg-green-50 px-2 py-1 rounded-full border border-green-200 shadow-sm animate-pulse">
                                     <Car size={12} />
                                     ×¢×•×“ ×›-{Math.floor(etaMinutes / 60)} ×©×³ ×•-{etaMinutes % 60} ×“×§×³
                                 </div>
                             )}
                        </div>
                    </div>
                </div>
              </div>

              {/* ×›×¤×ª×•×¨ ×“×œ×§ ×‘×™×Ÿ ××§×˜×¢×™× */}
              {showGasBtn && (
                  <div className="ml-4 mr-[30px] my-3 relative z-0">
                      <div className="absolute right-[21px] -top-4 -bottom-4 w-[2px] border-l-2 border-dashed border-gray-300"></div>
                      <button 
                        onClick={() => setGasModalSegment(stop.id)}
                        className="relative w-full bg-white border border-orange-200 rounded-xl p-2 flex items-center gap-3 shadow-sm active:scale-95 transition hover:bg-orange-50 group"
                      >
                          <div className="bg-orange-100 text-orange-600 p-1.5 rounded-lg group-hover:scale-110 transition">
                              <Fuel size={16} />
                          </div>
                          <div className="text-right">
                              <div className="text-xs font-bold text-gray-700">×“×œ×§ ×–×•×œ ×‘×“×¨×š?</div>
                              <div className="text-[10px] text-gray-400">×œ×—×¥ ×œ-3 ×ª×—× ×•×ª ××•××œ×¦×•×ª</div>
                          </div>
                          <div className="mr-auto bg-orange-500 text-white rounded-full p-1">
                              <Map size={12} />
                          </div>
                      </button>
                  </div>
              )}

            </div>
          );
        })}
      </div>

      {/* === ××•×“×œ ×›×¨×˜×™×¡×™×™×” (Main Modal) === */}
      {selectedStop && (
        <div className="fixed inset-0 z-50 flex items-end justify-center">
          <div className="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onClick={() => setSelectedStop(null)}></div>
          <div className="bg-white w-full max-w-md rounded-t-3xl shadow-2xl animate-in slide-in-from-bottom duration-300 relative z-10 max-h-[90vh] flex flex-col">
            <div className="w-full flex justify-center pt-3 pb-1" onClick={() => setSelectedStop(null)}>
                <div className="w-12 h-1.5 bg-gray-300 rounded-full"></div>
            </div>
            
            <div className="h-48 relative shrink-0 mt-2 mx-2 rounded-2xl overflow-hidden">
                {selectedStop.isEmoji ? (
                    <div className={`w-full h-full bg-gradient-to-br ${selectedStop.bgGradient} flex items-center justify-center`}>
                        <span className="text-8xl drop-shadow-lg">{selectedStop.emoji}</span>
                    </div>
                ) : (
                    <img src={selectedStop.image} alt={selectedStop.title} className="w-full h-full object-cover" />
                )}
                <button onClick={() => setSelectedStop(null)} className="absolute top-3 left-3 bg-black/30 text-white p-2 rounded-full"><X size={20} /></button>
            </div>

            <div className="p-5 overflow-y-auto">
                <p className="text-gray-600 leading-relaxed text-sm mb-6 bg-gray-50 p-3 rounded-xl border border-gray-100">{selectedStop.description}</p>
                {selectedStop.parking && (
                    <div className="mb-6">
                        <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">×¤×¨×˜×™ ×—× ×™×”</h3>
                        <div className="bg-white border border-gray-200 p-4 rounded-xl flex gap-3 shadow-sm">
                            <div className="w-10 h-10 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center shrink-0 font-bold text-lg">P</div>
                            <div>
                                <div className="font-bold text-gray-800 text-sm">{selectedStop.parking.name}</div>
                                <div className="text-gray-500 text-xs mt-0.5">{selectedStop.parking.address}</div>
                                <div className="mt-1.5 inline-block bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded font-bold">{selectedStop.parking.cost}</div>
                            </div>
                        </div>
                    </div>
                )}
                <div className="grid grid-cols-2 gap-3 pb-6">
                    <button onClick={() => openNavigation(selectedStop.coords, 'waze')} className="bg-blue-600 text-white py-3 rounded-xl text-sm font-bold shadow-lg shadow-blue-200 flex justify-center gap-2"><Navigation size={16}/> ×¡×¢ ×œ×™×¢×“</button>
                    <button onClick={() => openNavigation(selectedStop.parking?.coords, 'waze')} className="bg-gray-100 text-gray-800 py-3 rounded-xl text-sm font-bold border border-gray-200 flex justify-center gap-2">×¡×¢ ×œ×—× ×™×” P</button>
                </div>
            </div>
          </div>
        </div>
      )}

      {/* === ××•×“×œ ×“×œ×§ (Gas Modal) === */}
      {gasModalSegment && (
          <div className="fixed inset-0 z-50 flex items-end justify-center">
            <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setGasModalSegment(null)}></div>
            <div className="bg-white w-full max-w-md rounded-t-3xl shadow-2xl animate-in slide-in-from-bottom duration-300 relative z-10 max-h-[85vh] flex flex-col">
                <div className="p-5 border-b border-gray-100 flex justify-between items-center bg-orange-50 rounded-t-3xl">
                    <div>
                        <h2 className="text-xl font-black text-orange-600 flex items-center gap-2">
                            <Fuel size={24}/> ×“×œ×§ ×–×•×œ ×‘×“×¨×š
                        </h2>
                        <p className="text-xs text-orange-400 font-bold mt-1">3 ×”×ª×—× ×•×ª ×”××©×ª×œ××•×ª ×‘×™×•×ª×¨ ×‘××§×˜×¢ ×–×”</p>
                    </div>
                    <button onClick={() => setGasModalSegment(null)} className="bg-white text-orange-400 p-2 rounded-full shadow-sm"><X size={20} /></button>
                </div>

                <div className="p-5 space-y-4 overflow-y-auto bg-slate-50">
                    {GAS_STATIONS_DATA[gasModalSegment] ? GAS_STATIONS_DATA[gasModalSegment].map((station, idx) => (
                        <div key={idx} className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col gap-2">
                            <div className="flex justify-between items-start">
                                <div>
                                    <h3 className="font-black text-gray-800 text-lg">{station.name}</h3>
                                    <p className="text-xs text-gray-500">{station.address}</p>
                                </div>
                                <div className={`text-lg font-black px-2 py-1 rounded ${station.price.includes("$7") || station.price.includes("$8") ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-700'}`}>
                                    {station.price}
                                </div>
                            </div>
                            
                            {station.note && (
                                <div className="text-[11px] text-orange-600 bg-orange-50 px-2 py-1 rounded border border-orange-100 inline-block self-start">
                                    ğŸ’¡ {station.note}
                                </div>
                            )}

                            {station.price !== '---' && (
                                <button 
                                    onClick={() => openNavigation(station.address, 'waze')}
                                    className="mt-2 w-full bg-slate-800 text-white py-2 rounded-lg text-xs font-bold flex justify-center items-center gap-2 active:scale-95 transition"
                                >
                                    <Navigation size={12} /> × ×•×•×˜ ×œ×ª×—× ×” (Waze)
                                </button>
                            )}
                        </div>
                    )) : (
                        <p className="text-center text-gray-400">××™×Ÿ ××™×“×¢ ××™×•×—×“ ×¢×œ ×“×œ×§ ×‘××§×˜×¢ ×–×”.</p>
                    )}
                </div>
            </div>
          </div>
      )}

    </div>
  );
}

